define("j2d.input",["jquery","vanilla.override"],function($){"use strict";function getKey(e,a){return Object.keys(e).filter(function(t){return e[t]===a})[0]}var InputManager=function(e){this.j2d=e,this.id=e.id,this.element=e.element,this.data={mouse:{startPosition:{x:0,y:0},currentPosition:{x:0,y:0},previousDistance:0,distance:0},viewport:{position:{x:0,y:0}},enabled:!1,enableAdditionalData:!1,keysPressed:[],writeMode:!1,timePressed:0,preventAll:!1,cursor:{enabled:!1,image:"auto"}},this.keyMap={FULLSCREEN:[[InputManager.key.KEY_CTRL,InputManager.key.KEY_F11],"j2d.scene.toggleFullScreen",{}]}},checkKeyMap=function(e,enableCallback){void 0===enableCallback&&(enableCallback=!0);var j2d=e.data.manager.j2d,manager=e.data.manager,keyCode=e.which,keyMap=e.data.manager.keyMap;for(var index in keyMap)if(keyMap.hasOwnProperty(index)){var value=keyMap[index];if(!$.isArray(value[0])&&value[0]===keyCode&&value[1])return"string"==typeof value[1]&&(value[1]=eval("("+value[1]+")")),"function"==typeof value[1]&&enableCallback&&value[1](j2d,value[2]),!0;if($.isArray(value[0])&&manager.data.keysPressed.equals(value[0])&&value[1])return"string"==typeof value[1]&&(value[1]=eval("("+value[1]+")")),"function"==typeof value[1]&&enableCallback&&value[1](j2d,value[2]),!0}return!1},events={onMouseClick:function(e){if(!e.data.manager.j2d.isPlay()||!e.data.manager.j2d.element.hasClass("active"))return!0;var a=e.data.manager.data.keysPressed,t=getKey(InputManager.key,e.which)||"KEY_UNKNOWN_"+e.which,n=e.data.manager.data.mouse;2!==e.data.event?(0===e.data.event?(-1===$.inArray(InputManager.key[t],a)&&(a.push(InputManager.key[t]),e.data.manager.data.enableAdditionalData&&(n.startPosition.x=e.pageX,n.startPosition.y=e.pageY,n.distance=0,e.data.manager.data.timePressed=e.timeStamp)),(checkKeyMap(e,!1)||e.data.manager.data.preventAll)&&e.preventDefault()):((checkKeyMap(e)||e.data.manager.data.preventAll)&&e.preventDefault(),e.data.manager.data.enableAdditionalData&&(n.previousDistance=n.distance,n.startPosition.x=0,n.startPosition.y=0),a.splice(a.indexOf(InputManager.key[t]),1)),e.data.manager.element.trigger(0===e.data.event?"mouseKeyDown":"mouseKeyUp",{keyCode:t})):checkKeyMap(e,!1)&&e.preventDefault()},onMouseWheel:function(e){if(!e.data.manager.j2d.isPlay()||!e.data.manager.j2d.element.hasClass("active"))return!0;var a=e.data.manager.data.keysPressed,t=e.originalEvent.wheelDelta/120>0?getKey(InputManager.key,4):getKey(InputManager.key,5);e.which=e.originalEvent.wheelDelta/120>0?4:5,-1===$.inArray(InputManager.key[t],a)&&a.push(InputManager.key[t]),(checkKeyMap(e)||e.data.manager.data.preventAll)&&(e.preventDefault(),e.data.manager.fixMouseWheel()),e.data.manager.element.trigger("mouseWheel",{keyCode:t})},mouseWheelCancel:function(e,a){e.splice(e.indexOf(InputManager.key[a]),1)},onMouseMove:function(e){var a=e.data.manager,t=e.data.manager.data.mouse;a.data.mouse.currentPosition.x=e.pageX,a.data.mouse.currentPosition.y=e.pageY,e.data.manager.data.enableAdditionalData&&(t.distance=Math.sqrt(Math.pow(t.currentPosition.x-t.startPosition.x,2)+Math.pow(t.currentPosition.y-t.startPosition.y,2)).toFixed(1))},onKeyboardPress:function(e){if(!e.data.manager.j2d.isPlay()||!e.data.manager.element.hasClass("active"))return!0;var a=e.data.manager.data.keysPressed,t=getKey(InputManager.key,e.which)||"KEY_UNKNOWN_"+e.which;if(2===e.data.event&&!0===e.data.manager.data.writeMode){var n=String.fromCharCode(e.which||e.keyCode);e.preventDefault(),e.data.manager.element.focus().trigger("keyboardCharPress",{key:e.which||e.keyCode,keyCode:t,"char":n})}2!==e.data.event&&!1===e.data.manager.data.writeMode&&(0===e.data.event?(-1===$.inArray(InputManager.key[t],a)&&(a.push(InputManager.key[t]),e.data.manager.data.enableAdditionalData&&(e.data.manager.data.timePressed=e.timeStamp)),(checkKeyMap(e,!1)||e.data.manager.data.preventAll)&&e.preventDefault()):((checkKeyMap(e)||e.data.manager.data.preventAll)&&e.preventDefault(),a.splice(a.indexOf(InputManager.key[t]),1)),e.data.manager.element.trigger(0===e.data.event?"keyboardKeyDown":"keyboardKeyUp",{keyCode:t,key:e.which||e.keyCode})),2!==e.data.event&&!0===e.data.manager.data.writeMode&&e.data.manager.element.trigger(0===e.data.event?"keyboardKeyDown":"keyboardKeyUp",{keyCode:t,key:e.which||e.keyCode})},onTouchTap:function(e){if(!e.data.manager.j2d.isPlay()||!e.data.manager.j2d.element.hasClass("active"))return!0;var a=e.data.manager.data.keysPressed,t=getKey(InputManager.key,e.which+1)||"KEY_UNKNOWN_"+e.which,n=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],o=e.data.manager.data.mouse;0===e.data.event?(-1===$.inArray(InputManager.key[t],a)&&(a.push(InputManager.key[t]),e.data.manager.data.enableAdditionalData&&(o.startPosition.x=n.pageX,o.startPosition.y=n.pageY,o.distance=0,e.data.manager.data.timePressed=e.timeStamp)),(checkKeyMap(e,!1)||e.data.manager.data.preventAll)&&e.preventDefault()):((checkKeyMap(e)||e.data.manager.data.preventAll)&&e.preventDefault(),e.data.manager.data.enableAdditionalData&&(o.previousDistance=o.distance,o.startPosition.x=0,o.startPosition.y=0),a.splice(a.indexOf(InputManager.key[t]),1)),e.data.manager.element.trigger(0===e.data.event?"mouseKeyDown":"mouseKeyUp",{keyCode:t})},onTouchMove:function(e){var a=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],t=e.data.manager.data.mouse;t.currentPosition.x=a.pageX.toFixed(0),t.currentPosition.y=a.pageY.toFixed(0),e.data.manager.data.enableAdditionalData&&(t.distance=Math.sqrt(Math.pow(t.currentPosition.x-t.startPosition.x,2)+Math.pow(t.currentPosition.y-t.startPosition.y,2)).toFixed(1))}},bindEvents=function(e){var a="[guid="+e.id+"]";$(document).on("contextmenu",a,{manager:e,event:2},events.onMouseClick),$(document).on("mousedown",a,{manager:e,event:0},events.onMouseClick),$(document).on("mouseup",a,{manager:e,event:1},events.onMouseClick),$(document).on("mousewheel",a,{manager:e},events.onMouseWheel),$(document).on("mousemove",a,{manager:e},events.onMouseMove),$(document).on("keydown",null,{manager:e,event:0},events.onKeyboardPress),$(document).on("keyup",null,{manager:e,event:1},events.onKeyboardPress),$(document).on("keypress",null,{manager:e,event:2},events.onKeyboardPress),$(document).on("touchstart",a,{manager:e,event:0},events.onTouchTap),$(document).on("touchend",a,{manager:e,event:1},events.onTouchTap),$(document).on("touchmove ",a,{manager:e},events.onTouchMove)},unbindEvents=function(e){var a="[guid="+e.id+"]";$(document).off("contextmenu",a,{manager:e,event:1},events.onMouseClick),$(document).off("mousedown",a,{manager:e,event:0},events.onMouseClick),$(document).off("mouseup",a,{manager:e,event:1},events.onMouseClick),$(document).off("mousewheel",a,{manager:e},events.onMouseWheel),$(document).off("mousemove",a,{manager:e},events.onMouseMove),$(document).off("keydown",null,{manager:e,event:0},events.onKeyboardPress),$(document).off("keyup",null,{manager:e,event:1},events.onKeyboardPress),$(document).off("keypress",null,{manager:e,event:2},events.onKeyboardPress),$(document).off("touchstart",a,{manager:e,event:0},events.onTouchTap),$(document).off("touchend",a,{manager:e,event:1},events.onTouchTap),$(document).off("touchmove ",a,{manager:e},events.onTouchMove)};InputManager.prototype.init=function(){!this.data.enabled&&window.j2dPlugin.pluginInit&&(bindEvents(this),this.data.enabled=!0)},InputManager.prototype.update=function(){if(!this.data.enabled)return!1;var e=this.j2d.scene.canvas.offsetWidth/this.j2d.scene.width,a=this.j2d.scene.canvas.offsetHeight/this.j2d.scene.height,t=this.data.mouse.currentPosition.x/e,n=this.data.mouse.currentPosition.y/a,o=this.element.offset();this.data.viewport.x=this.j2d.scene.viewport.x+t-o.left,this.data.viewport.y=this.j2d.scene.viewport.y+n-o.top},InputManager.prototype.clear=function(){},InputManager.prototype.fixMouseWheel=function(){var e=this.data.keysPressed;-1!==$.inArray(InputManager.key.SCROLL_MOUSE_UP,e)?events.mouseWheelCancel(e,InputManager.key.SCROLL_MOUSE_UP):-1!==$.inArray(InputManager.key.SCROLL_MOUSE_DOWN,e)&&events.mouseWheelCancel(e,InputManager.key.SCROLL_MOUSE_DOWN)},InputManager.prototype.enable=function(){this.data.enabled||(bindEvents(this),this.data.enabled=!1)},InputManager.prototype.disable=function(){this.data.enabled&&(unbindEvents(this),this.data.enabled=!1)},InputManager.prototype.load=function(e){var a=JSON.stringify(this.keyMap);return this.keyMap=JSON.parse(e),a},InputManager.prototype.save=function(){return JSON.stringify(this.keyMap)},InputManager.prototype.setKeys=function(e){this.keyMap=$.extend(!0,{},this.keyMap,e)};var getPressData=function(e,a){return e.data.enableAdditionalData?{keyList:a,time:Date.now()-e.data.timePressed}:!0};return InputManager.prototype.getMouseMoveDistance=function(){return this.data.enableAdditionalData?{current:this.data.mouse.distance,previous:this.data.mouse.previousDistance}:0},InputManager.prototype.checkPressedKeyList=function(e){return $.isArray(e)?e.length!==this.data.keysPressed.length?!1:this.data.keysPressed.equals(e)?(this.fixMouseWheel(),getPressData(this,e)):(this.fixMouseWheel(),!1):isNaN(e)?!1:-1!==this.data.keysPressed.indexOf(e)?(this.fixMouseWheel(),getPressData(this,e)):(this.fixMouseWheel(),!1)},InputManager.prototype.checkPressedKeyMap=function(e){if(void 0===this.keyMap[e])return!1;var a=this.keyMap[e][0];return this.checkPressedKeyList(a)},InputManager.prototype.getPosition=function(){return this.j2d.vector.vec2df(this.data.viewport.x+.5,this.data.viewport.y+.5)},InputManager.prototype.onNode=function(e){return e.layer.visible?this.data.viewport.x>e.options.position.x&&this.data.viewport.x<e.options.position.x+e.options.size.x&&this.data.viewport.y>e.options.position.y&&this.data.viewport.y<e.options.position.y+e.options.size.y:!1},InputManager.prototype.setWriteMode=function(e){this.data.writeMode=e},InputManager.prototype.isWriteMode=function(){return!!this.data.writeMode},InputManager.prototype.setCursorImage=function(e){this.data.cursor.image='url("'+e+'"), auto',$(this.element).css("cursor",this.data.cursor.image)},InputManager.prototype.toggleCursor=function(e){void 0!==e?this.data.cursor.enable=e:this.data.cursor.enable=!this.data.cursor.enable,this.data.cursor.enable?$(this.element).css("cursor",this.data.cursor.image):(this.data.cursor.image=$(this.j2d.element).css("cursor"),$(this.element).css("cursor","none"))},InputManager.prototype.isCursorVisible=function(){return this.data.cursor.enable},InputManager.key={KEY_MOUSE_LEFT:1,KEY_MOUSE_MIDDLE:2,KEY_MOUSE_RIGHT:3,SCROLL_MOUSE_UP:4,SCROLL_MOUSE_DOWN:5,KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE_BAR:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW_KEY:91,KEY_RIGHT_WINDOW_KEY:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_LEFT_COMMAND:224,KEY_RIGHT_COMMAND:224},InputManager});