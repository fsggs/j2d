!function(e,t){"function"==typeof define&&define.amd?define("jquery.j2d",["jquery"],t):t(e.jQuery)}(global,function(e){var t,i=e,n={vector:{},math:{},dom:{},now:0,dt:0,io:void 0,pause:!1,frameLimit:60,sceneStartTime:0,sceneSkipTime:0,engine:!1,ready:!1,window:window,webGL:!1};return t=function(e,t){var i=this;i.element=e,i.options=t,i.init(),i.gameEngine=function(){i.options.now=Date.now(),setTimeout(function(){i.options.pause||(i.options.io&&i.options.io.update(),i.options.dt=(i.options.now-i.options.lastTime)/100,i.options.dt>i.options.sceneSkipTime&&(i.options.dt=0),i.options.sceneStartTime=i.options.now,setTimeout(i.options.engine,0),i.options.lastTime=i.options.now,i.options.io&&i.options.io.clear()),n(i.gameEngine)},i.options.frameLimit<60?i.options.sceneSkipTime:0)};var n=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/i.options.frameLimit)}}()},t.prototype.getInfo=function(){return{name:"jquery.j2d",version:"0.1.5",site:"https://github.com/fsggs/jquery.j2d",info:"jquery.j2d - jQuery plugin of the fork j2ds.",author:"DeVinterX, Skaner(j2ds)"}},t.prototype.getIO=function(){return this.options.io},t.prototype.init=function(){this.layers&&(this.layers.parent=this),this.scene&&(this.scene.parent=this),delete this.init},t.prototype.IOHandler=function(e){return this.options.io=e},t.prototype.setWindow=function(e){this.window=e?e:window},t.prototype.start=function(e,t){var i=this;i.options.engine=e||function(){i.element.html("Пожалуйста, инициализируйте игровую функцию!")},i.options.frameLimit=t||60,i.options.sceneSkipTime=1e3/i.options.frameLimit,i.options.lastTime=Date.now(),i.options.dt=0,i.options.sceneStartTime=i.options.lastTime,i.gameEngine()},t.prototype.pause=function(){this.options.pause=!0,this.element.addClass("pause")},t.prototype.resume=function(){this.options.pause=!1,this.element.removeClass("pause").focus()},t.prototype.isPlay=function(){return!this.options.pause},t.prototype.enableWebGL=function(){this.options.webGL=!0},t.prototype.setActiveEngine=function(e){this.options.engine=e},t.prototype.getDevice=function(){return this.device},t.prototype.device={width:parseInt(i(document).width())<parseInt(screen.width)?parseInt(i(document).width()):parseInt(screen.width),height:parseInt(i(document).height())<parseInt(screen.height)?parseInt(i(document).height()):parseInt(screen.height),resize:function(){this.width=window.innerWidth,this.height=window.innerHeight}},t.prototype.vector={vec2df:function(e,t){return{x:e,y:t}},vec2di:function(e,t){return{x:e>>0,y:t>>0}}},t.prototype.math={toInt:function(e){return e>>0},randomColor:function(e,t,i){return"rgba("+this.random(e,t)+", "+this.random(e,t)+", "+this.random(e,t)+", "+i+")"},random:function(e,t,i){var n=Math.floor(Math.random()*(t-e+1)+e);return i&&0==n?this.random(e,t,i):n},rad:function(e){return e*(Math.PI/180)}},t.prototype.getLayers=function(){return this.layers},t.prototype.layers={parent:void 0,list:{}},t.prototype.layers.getLayer=function(e){return this.list[e]},t.prototype.layers.add=function(e,t){if(this.list[e])return!1;var i={},n=this.parent;return i.layerName=e,i.canvas=document.createElement("canvas"),i.canvas.width=n.scene.width,i.canvas.height=n.scene.height,i.width=n.scene.width,i.height=n.scene.height,i.context=i.canvas.getContext("2d"),i.context.shadowColor="rgba(0,0,0,0)",i.canvas.style.zIndex=1e3+t,i.canvas.style.position="absolute",i.canvas.style.left="0",i.canvas.style.top="0",i.canvas.id=e,i.opacity=1,i.angle=0,i.visible=1,i.fillColor=!1,i.onContext=function(e){e(this.context)},i.fill=function(e){this.fillColor=e,this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height)},i.setOpacity=function(e){this.canvas.style.opacity=e,this.opacity=e},i.getOpacity=function(){return this.opacity},i.setVisible=function(e){e?(this.canvas.style.display="block",this.visible=!0):(this.canvas.style.display="none",this.visible=!1)},i.isVisible=function(){return this.visible},i.setIndex=function(e){this.canvas.style.zIndex=1e3+e},i.clear=function(){this.context.clearRect(0,0,this.width,this.height)},i.clearNode=function(e){e.isLookScene()&&this.context.clearRect(e.pos.x-n.scene.viewport.x,e.pos.y-n.scene.viewport.y,e.size.x,e.size.y)},i.clearRect=function(e,t){this.context.clearRect(e.x-n.scene.viewport.x,e.y-n.scene.viewport.y,t.x,t.y)},i.resize=function(e,t){this.canvas.width=e,this.canvas.height=t,this.width=e,this.height=t,this.fillColor&&(this.context.save(),this.context.fillStyle=this.fillColor,this.context.fillRect(0,0,this.width,this.height),this.context.restore())},this.list[e]=i,n.options.ready&&n.element.append(this.list[e].canvas),i},t.prototype.getScene=function(){return this.scene},t.prototype.scene={parent:void 0,enableFullscreen:!1,layerName:"sceneNode",layers:parent.layers?parent.layers:{}},t.prototype.scene.resize=function(e,t){var i=this.parent;this.width=e,this.height=t;for(var n in i.layers.list)i.layers.list.hasOwnProperty(n)&&i.layers.list[n].resize(e,t)},t.prototype.scene.async=function(e,t){setTimeout(e.call(e,t),0)},t.prototype.scene.setGameState=function(e){this.parent.setActiveEngine(e),this.parent.element.trigger("changedGameState")},t.prototype.scene.start=function(e,t){this.parent.options.io&&this.parent.options.io.init(),this.parent.element.trigger("beforeStart"),this.parent.start(e,t),this.parent.element.trigger("afterStart")},t.prototype.scene.fullScreen=function(e){var t=document.getElementById(this.parent.element.attr("id"));void 0===t.requestFullscreen&&(t.requestFullscreen=t.webkitRequestFullscreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullscreen),void 0===document.exitFullscreen&&(document.exitFullscreen=document.webkitExitFullscreen||document.webkitCancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen),e?t.requestFullscreen():document.exitFullscreen()},t.prototype.scene.resizeToFullPage=function(e){var t=this.parent,i=this;e?(i.originalWidth=i.width,i.originalHeight=i.height,i.resize(t.device.width,t.device.height),i.enableFullscreen=!0):(i.resize(i.originalWidth,i.originalHeight),i.enableFullscreen=!1)},t.prototype.scene.scaleToFullScreen=function(e){var t,i;if(e){for(i in this.parent.layers.list)this.parent.layers.list.hasOwnProperty(i)&&(t=this.parent.layers.list[i].canvas,t.style.width=this.parent.device.width+"px",t.style.height=this.parent.device.height+"px");this.enableFullscreen=!0,this.parent.element.width(this.parent.device.width).height(this.parent.device.height)}else{for(i in this.parent.layers.list)this.parent.layers.list.hasOwnProperty(i)&&(t=this.parent.layers.list[i].canvas,t.style.width=this.width+"px",t.style.height=this.height+"px");this.enableFullscreen=!1,this.parent.element.width(this.width).height(this.height)}},t.prototype.scene.toggleFullScreen=function(e,t){void 0===t&&(t={fullscreen:void 0}),!e.scene.enableFullscreen||t.fullscreen?e.scene.fullScreen(!0):e.scene.fullScreen(!1)},t.prototype.scene.setViewPosition=function(e){this.parent.scene.viewport.x=e.x-Math.ceil(this.parent.scene.width/2),this.parent.scene.viewport.y=e.y-Math.ceil(this.parent.scene.height/2)},t.prototype.scene.setViewFocus=function(e,t){this.parent.scene.viewport.x=e.getPosition().x-Math.ceil(this.parent.scene.width/2)+(t?t.x:0),this.parent.scene.viewport.y=e.getPosition().y-Math.ceil(this.parent.scene.height/2)+(t?t.y:0)},t.prototype.scene.viewMove=function(e){this.parent.scene.viewport.x+=e.x,this.parent.scene.viewport.y+=e.y},t.prototype.scene.clear=function(){this.getLayer().clear()},t.prototype.scene.getLayer=function(){return this.parent.layers.getLayer("sceneNode")},t.prototype.scene.init=function(e,t){var n=this.parent;n.element.trigger("beforeInit"),this.width=this.originalWidth=e,this.height=this.originalHeight=t,this.parent.element.width(e).height(t),n.layers.add("sceneNode",0),this.context=n.layers.getLayer("sceneNode").context,this.canvas=n.layers.getLayer("sceneNode").canvas,this.visible=!0,this.cancelClear=!1,this.viewport=n.vector.vec2df(0,0),n.element.trigger("afterInit"),i(window).ready(function(){for(var e in n.layers.list)n.layers.list.hasOwnProperty(e)&&n.element.append(n.layers.getLayer(e).canvas);n.options.ready=!0,n.element.trigger("ready")})},t.initJQueryPlugin=function(){i.fn.j2d=function(e){return e=i.extend(!0,{},n,e),this.filter("div.canvas:not([guid])").each(function(){i(this).data("j2d",new t(i(this),e)).addClass("j2d");var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,i="x"==e?t:3&t|8;return i.toString(16)});i(this).attr("guid",n);var s=i(this).attr("id");("undefined"==typeof s||s===!1)&&i(this).attr("id",n);var o=i(this).attr("tabindex");("undefined"==typeof o||o===!1)&&i(this).attr("tabindex","-1"),i(this).focus()}),1===i(this).length?i(this).data("j2d"):void 0};var e=!1;i(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange msfullscreenchange","div.canvas[guid]",function(t){e=!!(document.webkitFullscreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement||document.msFullscreenElement),e||i(this).data("j2d").scene.resizeToFullPage(e)}),i(document).on("click","div.canvas[guid].pause",function(){i(this).data("j2d").resume()}),i(window).on("focus",function(){i("div.canvas[guid]").each(function(){i(this).data("j2d").resume()})}).on("blur",function(){i("div.canvas[guid]").each(function(){i(this).data("j2d").pause()})}),i(window).on("resize",function(){i("div.canvas[guid]").each(function(){i(this).data("j2d").device.resize(),e&&i(this).data("j2d").scene.resizeToFullPage(e)})})},t});