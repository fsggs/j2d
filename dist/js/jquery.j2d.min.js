/**
 * J2D (jQuery Canvas Graphic Engine plugin)
 *
 * @authors DeVinterX, Skaner(j2Ds)
 * @license BSD
 * @version 0.2.0-dev
 */

if (global === undefined) {var global = window || this}
if (typeof define !== 'function' || !define.amd) {global.J2D = true; global.exports = {}}
!function(e,t){"function"==typeof define&&define.amd?define("jquery.j2d",["jquery","core/SceneManager","utils/DeviceUtil"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery"),require("core/SceneManager"),require("utils/DeviceUtil")):t(e.jQuery,e.SceneManager,e.DeviceUtil)}("undefined"!=typeof window?window:global,function(e,t,a){"use strict";var n={id:null,io:null,deltaTime:0,pause:!1,ready:!1,frameLimit:60,smoothing:!0,webGL:!1},o=function(e,n){var o=this;this.element=e,this.data=n,this.device=new a,this.scene=new t(this),Object.defineProperty(this,"WebGL",{get:function(){return o.data.webGL},set:function(e){o.data.webGL=!!e,e&&!o.data.webGL?o.element.addClass("WebGL"):!e&&o.data.webGL&&o.element.removeClass("WebGL")}}),Object.defineProperty(this,"smoothing",{get:function(){return o.data.smoothing},set:function(e){o.data.smoothing=!!e}}),Object.defineProperty(this,"io",{get:function(){return o.data.io},set:function(e){return o.data.io=e}}),Object.defineProperty(this,"isPlay",{get:function(){return!o.data.pause},set:function(){}})};return o.prototype.start=function(){this.scene.start(),this.trigger("start")},o.prototype.stop=function(){this.scene.stop(),this.trigger("stop")},o.prototype.pause=function(){this.data.io&&this.data.io.flush(),this.data.pause=!0,this.element.addClass("pause"),this.trigger("pause")},o.prototype.resume=function(){this.element.removeClass("pause").focus(),this.data.pause=!1,this.data.io&&this.data.io.flush(),this.trigger("resume")},o.prototype.getSceneManager=function(){return this.scene},o.prototype.getLayersManager=function(){return this.scene.layersManager},o.prototype.getFrameManager=function(){return this.scene.frameManager},o.prototype.on=function(){},o.prototype.once=function(){},o.prototype.off=function(){},o.prototype.trigger=function(){},o.util={disableSmoothing:function(e){var t=global.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),a=t?parseInt(t[2],10):!1;e.imageSmoothingEnabled=!1,e.mozImageSmoothingEnabled=!1,e.oImageSmoothingEnabled=!1,a&&29>=a&&(e.webkitImageSmoothingEnabled=!1),e.msImageSmoothingEnabled=!1}},o.prototype.util=o.util,(o.initPlugin=function(){if(void 0!==window.j2dPlugin)return null;window.j2dPlugin={pluginInit:!0},e.fn.j2d=function(t){this.filter("div.canvas:not([guid])").each(function(){var t=e.extend(!0,{},n,t),a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,a="x"==e?t:3&t|8;return a.toString(16)});t.id=a,e(this).attr("guid",a);var i=e(this).attr("id");("undefined"==typeof i||i===!1)&&e(this).attr("id",a);var r=e(this).attr("tabindex");("undefined"==typeof r||r===!1)&&e(this).attr("tabindex","-1"),e(this).data("j2d",new o(e(this),t)).addClass("j2d"),e(this).click().focus()});var a=[];return this.filter("div.canvas[guid]").each(function(){a.push(e(this).data("j2d"))}),1===a.length?e(this).data("j2d"):a};var t=function(){return!!(document.webkitFullscreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement||document.msFullscreenElement)};e(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",function(){var a=t();a||(e("div.canvas[guid].active").data("j2d").scene.resizeToFullPage(a),e("div.canvas[guid]:not(.active)").toggle(!a))}),e(document).on("click","div.canvas[guid].pause",function(){e(this).data("j2d").resume();var t=this;e("div.canvas[guid]:not(.pause-disable):not(:focus)").each(function(){t!==this&&e(this).removeClass("active").data("j2d").pause()}),e("div.canvas[guid].active.pause-disable:not(:focus)").each(function(){t!==this&&e(this).removeClass("active")})}),e(document).on("click touch mouseenter","div.canvas[guid]:not(.resume-by-click):not(:focus)",function(){e(this).addClass("active").focus().data("j2d").resume();var t=this;e("div.canvas[guid]:not(.pause-disable):not(:focus)").each(function(){t!==this&&e(this).removeClass("active").data("j2d").pause()}),e("div.canvas[guid].active.pause-disable:not(:focus)").each(function(){t!==this&&e(this).removeClass("active")})}),e(window).on("focus",function(){e("div.canvas[guid].active").each(function(){e(this).data("j2d").resume()})}).on("blur",function(){e("div.canvas[guid]").each(function(){e(this).data("j2d").pause()})}),e(window).on("resize",function(){e("div.canvas[guid]").each(function(){e(this).data("j2d").device.onResize()});var a=t();a&&e("div.canvas[guid].active").data("j2d").scene.resizeToFullPage(a)})})(),void 0===global.J2D&&(global.J2D=o),o}),function(e,t){"function"==typeof define&&define.amd?define("core/FrameManager",["utils/ArrayMap"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("utils/ArrayMap")):t(e.ArrayMap)}("undefined"!=typeof window?window:global,function(e){"use strict";var t,a=new e,n=new e,o=0,i={frameLimit:60,frameRun:!1,breakAnimationFrame:!1},r=function(){return global.requestAnimationFrame||global.webkitRequestAnimationFrame||global.mozRequestAnimationFrame||global.oRequestAnimationFrame||global.msRequestAnimationFrame||function(e){i.breakAnimationFrame?i.breakAnimationFrame=!1:(o>=Number.MAX_SAFE_INTEGER-1&&(o=0),0===o&&(o=Date.now()),global.setTimeout(e.bind(this,Date.now()-o),1e3/i.frameLimit))}}(),s=function(){return o=0,global.cancelAnimationFrame||global.webkitCancelAnimationFrame||global.mozCancelAnimationFrame||global.oCancelAnimationFrame||global.msCancelAnimationFrame}(),u=function(){};return u.prototype.start=function(e,t,o){var r={j2d:null,frameLimit:i.frameLimit,now:0,deltaTime:0,lastTime:0,sceneStartTime:0,sceneSkipTime:0,asyncUpdate:!0,asyncRender:!0};if(void 0!==o.frameLimit&&o.frameLimit<=i.frameLimit&&(r.frameLimit=o.frameLimit),void 0===o.j2d)throw"j2d not transported to FrameManager.start(id, engine, {... j2d: j2d ...});";r.j2d=o.j2d,r.interval=1e3/r.frameLimit,r.lastTime=Date.now(),a.add(e,t),n.add(e,r),i.frameRun||this.pulse()},u.prototype.stop=function(e){a.remove(e),n.remove(e)},u.prototype.pulse=function(){this.runMainLoop(Date.now())},u.prototype.runMainLoop=function(e,t){return void 0===t&&(t=this),a.length<=0&&i.frameRun?(i.breakAnimationFrame=!0,i.frameRun=!1,s(this.runMainLoop)):(i.frameRun=!0,r(function(e){t.runMainLoop(e,t)}),void a.each(function(t){if(a.hasOwnProperty(t)&&"object"==typeof a[t]){var o=a[t],i=n[t];i.now=Date.now(),i.deltaTime=(i.now-i.lastTime)/100,i.j2d.data.io&&!i.j2d.data.pause&&i.j2d.data.io.update(),i.j2d.data.pause||(void 0!==o.update&&"function"==typeof o.update&&(i.asyncUpdate?setTimeout(o.update.bind(this,e,i),0):o.update(e,i)),100*i.deltaTime>i.interval&&(i.lastTime=i.now-100*i.deltaTime%i.interval,void 0!==o.render&&"function"==typeof o.render&&(i.asyncRender?setTimeout(o.render.bind(this,e,i),0):o.render(e,i)))),i.j2d.data.io&&!i.j2d.data.pause&&i.j2d.data.io.clear()}}))},u.prototype.setDefaultFrameLimit=function(e){60>=e&&e>0&&(i.frameLimit=e)},u.Init=function(){return void 0!==global.J2D?global.instanceFrameManager||(global.instanceFrameManager=new u):t||(t=new u)},void 0===global.J2D&&(global.FrameManager=u),u}),function(e,t){"function"==typeof define&&define.amd?define("core/LayersManager",[],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():t()}("undefined"!=typeof window?window:global,function(){"use strict";var e=function(e){this.j2d=e,this.list={}};return void 0!==global.J2D&&(global.LayersManager=e),e}),function(e,t){"function"==typeof define&&define.amd?define("core/SceneManager",["jquery","core/WebGL2D","core/FrameManager","core/LayersManager"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery"),require("core/WebGL2D"),require("core/FrameManager"),require("core/LayersManager")):t(e.jQuery,e.WebGL2D,e.FrameManager,e.LayersManager)}("undefined"!=typeof window?window:global,function(e,t,a,n){"use strict";var o={width:0,height:0,originalWidth:0,originalHeight:0,originalMargin:0,visible:!0,position:"absolute",top:0,left:0,zIndex:1e3,opacity:1,backgroundColor:!1,frameLimit:60,enableFullScreen:!1,viewport:{x:0,y:0},gameState:function(){}},i=function(e){var t=this;this.j2d=e,this.canvas=null,this.context=null,this.frameManager=a.Init(),this.layersManager=new n(this.j2d),Object.defineProperty(this,"backgroundColor",{get:function(){return t.data.backgroundColor},set:function(e){t.data.backgroundColor=e,t.context.fillStyle=e,t.context.fillRect(0,0,t.data.width,t.data.height)}}),Object.defineProperty(this,"opacity",{get:function(){return t.data.opacity},set:function(e){t.data.opacity=e,t.canvas.style.opacity=e}}),Object.defineProperty(this,"visible",{get:function(){return t.data.visible},set:function(e){t.data.visible=!!e,t.canvas.style.display=e?"block":"none"}}),Object.defineProperty(this,"zIndex",{get:function(){return 1e3-t.data.zIndex},set:function(e){t.data.zIndex=1e3+e,t.canvas.style.zIndex=1e3+e}}),Object.defineProperty(this,"viewport",{get:function(){return t.data.viewport},set:function(){}})};return i.prototype.init=function(t){return this.data=e.extend(!0,{},o,t),this.j2d.trigger("beforeInit"),this.data.originalWidth=this.data.width,this.data.originalHeight=this.data.height,this.data.originalMargin=this.j2d.element.css("margin"),this.j2d.element.width(this.data.width).height(this.data.height),this.initCanvas(),this.j2d.trigger("afterInit"),this},i.prototype.initCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.data.width,this.canvas.height=this.data.height,this.canvas.style.zIndex=this.data.zIndex,this.canvas.style.position=this.data.position,this.canvas.style.left=this.data.left,this.canvas.style.top=this.data.top,this.j2d.data.webGL?(t.enable(this.canvas),this.context=this.canvas.getContext("WebGL-2d")):this.context=this.canvas.getContext("2d"),this.j2d.data.smoothing||this.j2d.util.disableSmoothing(this.context),this.context.shadowColor="rgba(0,0,0,0)",this.data.backgroundColor&&(this.backgroundColor=this.data.backgroundColor),this.data.opacity&&(this.opacity=this.data.opacity),this.data.visible&&(this.visible=this.data.visible),this.data.zIndex&&(this.zIndex=1e3-this.data.zIndex),this.j2d.element.append(this.canvas)},i.prototype.clear=function(e,t){return void 0!==e&&void 0!==t?this.context.clearRect(e.x-this.viewport.x,e.y-this.viewport.y,t.x,t.y):this.context.clearRect(0,0,this.data.width,this.data.height),this},i.prototype.resize=function(e,t){return this.canvas.width=this.data.width=e,this.canvas.height=this.data.height=t,this.data.backgroundColor&&(this.context.save(),this.clear(),this.backgroundColor=this.data.backgroundColor,this.context.restore()),this.j2d.data.smoothing||this.j2d.util.disableSmoothing(this.context),this},i.prototype.setGameState=function(e){return this.data.gameState=e||function(){console.warn("Error in game state function!")},this.frameManager.stop(this.j2d.data.id),this.frameManager.start(this.j2d.data.id,this.data.gameState,{j2d:this.j2d,frameLimit:this.data.frameLimit}),this.j2d.trigger("changedGameState"),this},i.prototype.async=function(e,t){return setTimeout(e.call(e,t),0),this},i.prototype.start=function(){return this.j2d.data.io&&this.j2d.data.io.init(),this.j2d.trigger("beforeStart"),this.frameManager.stop(this.j2d.data.id),this.frameManager.start(this.j2d.data.id,this.data.gameState,{j2d:this.j2d,frameLimit:this.data.frameLimit}),this.j2d.trigger("afterStart"),this},i.prototype.stop=function(){return this.frameManager.stop(this.j2d.data.id),this},i.prototype.fullScreen=function(e){var t=document.getElementById(this.j2d.element.attr("id"));return void 0===t.requestFullscreen&&(t.requestFullscreen=t.webkitRequestFullscreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullscreen),void 0===document.exitFullscreen&&(document.exitFullscreen=document.webkitExitFullscreen||document.webkitCancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen),e?t.requestFullscreen():document.exitFullscreen(),this},i.prototype.resizeToFullPage=function(t){e("div.canvas[guid]:not(.active)").toggle(t);var a=this.j2d,n=this;return t?(n.data.originalWidth=n.data.width,n.data.originalHeight=n.data.height,n.resize(a.device.width,a.device.height),n.data.enableFullscreen=!0,a.element.width(a.device.width).height(a.device.height).css("margin",0)):(n.resize(n.data.originalWidth,n.data.originalHeight),n.data.enableFullscreen=!1,a.element.width(n.data.originalWidth).height(n.data.originalHeight).css("margin",n.data.originalMargin)),this},i.prototype.toggleFullScreen=function(e,t){return void 0===t&&(t={fullscreen:null}),!e.scene.enableFullscreen||t.fullscreen?e.scene.fullScreen(!0):e.scene.fullScreen(!1),this},void 0!==global.J2D&&(global.SceneManager=i),i}),function(e,t){"function"==typeof define&&define.amd?define("core/ViewportManager",["utils/ArrayMap","nodes/CameraNode","utils/Vector2d"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("utils/ArrayMap"),require("nodes/CameraNode"),require("utils/Vector2d")):t(e.ArrayMap,e.CameraNode,e.Vector2d)}("undefined"!=typeof window?window:global,function(e,t,a){"use strict";var n=function(e,t){var a={offset:{x:t.offset.x,y:t.offset.y},size:{x:0,y:0},scale:1};return a.size.x=e.x<t.size.x?e.x:t.size.x,a.size.y=e.y<t.size.y?e.y:t.size.y,a.scale=(e.x/t.size.x+e.y/t.size.y)/2,a},o=function(){this.cameras=new e,this.camera="No active cameras",this.screen={x:0,y:0},this.data={offset:{x:0,y:0},size:{x:0,y:0},scale:1}};return o.prototype.setScreen=function(e){if("object"==typeof e){if(e instanceof Array&&2==e.length)return this.screen={x:e[0],y:e[1]},this;void 0!==e.x&&void 0!==e.y&&(this.screen={x:e.x,y:e.y})}return this},o.prototype.addCamera=function(e,a){return a instanceof t?(this.cameras.add(e,a),this):void 0},o.prototype.removeCamera=function(e){return this.cameras.remove(e),this.camera==e&&(this.camera="No active cameras",this.data={offset:{x:0,y:0},size:{x:0,y:0},scale:1}),this},o.prototype.updateViewport=function(e){return void 0!==this.cameras[e]&&this.cameras[e]instanceof t&&(this.data=this.cameras[e].getCameraViewport(this.screen,n)),this},o.prototype.setViewport=function(e,t){return void 0!==e&&"object"==typeof e&&e instanceof a&&(this.data.offset=e.getVector()),void 0!==t&&"object"==typeof t&&t instanceof a&&(this.data.offset=t.getVector()),this.data.scale=n(this.screen,this.data),this},o.prototype.getViewport=function(){return this.data},void 0!==global.J2D&&(global.ViewportManager=o),o}),function(e,t){"function"==typeof define&&define.amd?define("core/WebGL2D",[],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():t()}("undefined"!=typeof window?window:global,function(){"use strict";function e(e){return e>0&&0===(e-1&e)}function t(e){return this.clearStack(e)}var a={identity:[1,0,0,0,1,0,0,0,1],multiply:function(e,t){var a=e[0],n=e[1],o=e[2],i=e[3],r=e[4],s=e[5],u=e[6],d=e[7],c=e[8],l=t[0],f=t[1],h=t[2],p=t[3],g=t[4],m=t[5],y=t[6],v=t[7],b=t[8];t[0]=l*a+p*n+y*o,t[1]=f*a+g*n+v*o,t[2]=h*a+m*n+b*o,t[3]=l*i+p*r+y*s,t[4]=f*i+g*r+v*s,t[5]=h*i+m*r+b*s,t[6]=l*u+p*d+y*c,t[7]=f*u+g*d+v*c,t[8]=h*u+m*d+b*c},vec2_multiply:function(e,t){var a=[];return a[0]=t[0]*e[0]+t[3]*e[1]+t[6],a[1]=t[1]*e[0]+t[4]*e[1]+t[7],a},transpose:function(e){return[e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]]}},n=16;t.prototype.clearStack=function(e){this.m_stack=[],this.m_cache=[],this.c_stack=0,this.valid=0,this.result=null;for(var t=0;n>t;t++)this.m_stack[t]=this.getIdentity();void 0!==e?this.m_stack[0]=e:this.setIdentity()},t.prototype.setIdentity=function(){this.m_stack[this.c_stack]=this.getIdentity(),this.valid===this.c_stack&&this.c_stack&&this.valid--},t.prototype.getIdentity=function(){return[1,0,0,0,1,0,0,0,1]},t.prototype.getResult=function(){if(!this.c_stack)return this.m_stack[0];var e=a.identity;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var t=this.valid;t<this.c_stack+1;t++)e=a.multiply(this.m_stack[t],e),this.m_cache[t]=e;return this.valid=this.c_stack-1,this.result=this.m_cache[this.c_stack],this.result},t.prototype.pushMatrix=function(){this.c_stack++,this.m_stack[this.c_stack]=this.getIdentity()},t.prototype.popMatrix=function(){0!==this.c_stack&&this.c_stack--};var o=t.prototype.getIdentity();t.prototype.translate=function(e,t){o[6]=e,o[7]=t,a.multiply(o,this.m_stack[this.c_stack])};var i=t.prototype.getIdentity();t.prototype.tr=function(e,t,n,o,r,s){i[0]=e,i[1]=t,i[3]=n,i[4]=o,i[6]=r,i[7]=s,a.multiply(i,this.m_stack[this.c_stack])};var r=t.prototype.getIdentity();t.prototype.scale=function(e,t){r[0]=e,r[4]=t,a.multiply(r,this.m_stack[this.c_stack])};var s=t.prototype.getIdentity();t.prototype.rotate=function(e){var t,n;t=Math.sin(-e),n=Math.cos(-e),s[0]=n,s[3]=t,s[1]=-t,s[4]=n,a.multiply(s,this.m_stack[this.c_stack])};var u=global.WebGL2D=function(e,a){this.canvas=e,this.options=a||{},this.gl=void 0,this.fs=void 0,this.vs=void 0,this.shaderProgram=void 0,this.transform=new t,this.shaderPool=[],this.maxTextureSize=void 0,e.gl2d=this,e.$getContext=e.getContext,e.getContext=function(t){return function(a){if(!t.options.force&&"WebGL-2d"!==a||0===e.width||0===e.height)return t.canvas.$getContext(a);if(t.gl)return t.gl;var n=t.gl=t.canvas.$getContext("experimental-webgl");return"undefined"==typeof n||null===n?t.canvas.$getContext("2d"):(t.initShaders(),t.initBuffers(),t.initCanvas2DAPI(),n.enable(n.BLEND),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),t.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),n)}}(this),this.postInit()};u.enable=function(e,t){return e.gl2d||new u(e,t)};var d={texture:1,crop:2,path:4};u.prototype.getFragmentShaderSource=function(e){var t=["#ifdef GL_ES","precision highp float;","#endif","#define hasTexture "+(e&d.texture?"1":"0"),"#define hasCrop "+(e&d.crop?"1":"0"),"varying vec4 vColor;","#if hasTexture","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","#if hasCrop","uniform vec4 uCropSource;","#endif","#endif","void main(void) {","#if hasTexture","#if hasCrop","gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x * uCropSource.z, vTextureCoord.y * uCropSource.w) + uCropSource.xy);","#else","gl_FragColor = texture2D(uSampler, vTextureCoord);","#endif","#else","gl_FragColor = vColor;","#endif","}"].join("\n");return t},u.prototype.getVertexShaderSource=function(e,t){e=e||1;var a=["#define hasTexture "+(t&d.texture?"1":"0"),"attribute vec4 aVertexPosition;","#if hasTexture","varying vec2 vTextureCoord;","#endif","uniform vec4 uColor;","uniform mat3 uTransforms["+e+"];","varying vec4 vColor;","uniform mat4 pMatrix;","mat3 crunchStack(void) {","mat3 result = uTransforms[0];","for (int i = 1; i < "+e+"; ++i) {","result = uTransforms[i] * result;","}","return result;","}","void main(void) {","vec3 position = crunchStack() * vec3(aVertexPosition.x, aVertexPosition.y, 1.0);","gl_Position = pMatrix * vec4(position, 1.0);","vColor = uColor;","#if hasTexture","vTextureCoord = aVertexPosition.zw;","#endif","}"].join("\n");return a},u.prototype.initShaders=function(e,t){var a=this.gl;e=e||1,t=t||0;var n=this.shaderPool[e];if(n||(n=this.shaderPool[e]=[]),n=n[t])a.useProgram(n),this.shaderProgram=n;else{var o=this.fs=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(this.fs,this.getFragmentShaderSource(t)),a.compileShader(this.fs),!a.getShaderParameter(this.fs,a.COMPILE_STATUS))throw"fragment shader error: "+a.getShaderInfoLog(this.fs);var i=this.vs=a.createShader(a.VERTEX_SHADER);if(a.shaderSource(this.vs,this.getVertexShaderSource(e,t)),a.compileShader(this.vs),!a.getShaderParameter(this.vs,a.COMPILE_STATUS))throw"vertex shader error: "+a.getShaderInfoLog(this.vs);var r=this.shaderProgram=a.createProgram();if(r.stackDepth=e,a.attachShader(r,o),a.attachShader(r,i),a.linkProgram(r),!a.getProgramParameter(r,a.LINK_STATUS))throw"Could not initialise shaders.";a.useProgram(r),r.vertexPositionAttribute=a.getAttribLocation(r,"aVertexPosition"),a.enableVertexAttribArray(r.vertexPositionAttribute),r.uColor=a.getUniformLocation(r,"uColor"),r.uSampler=a.getUniformLocation(r,"uSampler"),r.uCropSource=a.getUniformLocation(r,"uCropSource"),r.pMatrix=a.getUniformLocation(r,"pMatrix"),r.uTransforms=[];for(var s=0;e>s;++s)r.uTransforms[s]=a.getUniformLocation(r,"uTransforms["+s+"]");this.shaderPool[e][t]=r}return l[0]=2/this.canvas.width,l[5]=-2/this.canvas.height,a.uniformMatrix4fv(this.shaderProgram.pMatrix,!1,l),a.viewport(0,0,this.canvas.width,this.canvas.height),this.shaderProgram};var c=new Float32Array([0,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0]),l=new Float32Array(16);return l[10]=1,l[11]=1,l[12]=-1,l[13]=1,u.prototype.initBuffers=function(){var e=this.gl;e.rectVertexPositionBuffer=e.createBuffer(),e.rectVertexColorBuffer=e.createBuffer(),e.pathVertexPositionBuffer=e.createBuffer(),e.pathVertexColorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,e.rectVertexPositionBuffer),e.bufferData(e.ARRAY_BUFFER,c,e.STATIC_DRAW)},u.instances=[],u.prototype.postInit=function(){u.instances.push(this)},u.prototype.initCanvas2DAPI=function(){function t(e,t,a){return 0>a&&(a+=1),a>1&&(a-=1),1/6>a?e+6*(t-e)*a:.5>a?t:2/3>a?e+(t-e)*(2/3-a)*6:e}function a(e,a,n,o){var i,r,s,u,d;return e=(e%360+360)%360/360,a=a>100?1:a/100,a=0>a?0:a,n=n>100?1:n/100,n=0>n?0:n,0==a?i=r=s=n:(d=.5>n?n*(1+a):n+a-n*a,u=2*n-d,i=t(u,d,e+1/3),r=t(u,d,e),s=t(u,d,e-1/3)),[i,r,s,o]}function n(e){var t,o,i,r,s,u,d=[];if(t=v.exec(e)){if(r=t[1],s=parseFloat(t[8]),r&&isNaN(s)||!r&&!isNaN(s))return!1;u=t[3];for(var c=2;8>c;c+=2){if(o=t[c],i=t[c+1],i!==u)return!1;i?(o=o>100?1:o/100,o=0>o?0:o):(o=o>255?1:o/255,o=0>o?0:o),d.push(o)}d.push(r?s:1)}else if(t=b.exec(e))r=t[1],s=parseFloat(t[5]),d=a(t[2],t[3],t[4],parseFloat(r&&s?s:1));else if(t=E.exec(e)){var l=parseInt(t[1],16);d=[((16711680&l)>>16)/255,((65280&l)>>8)/255,(255&l)/255,1]}else if(t=w.exec(e)){var f="#"+[t[1],t[1],t[2],t[2],t[3],t[3]].join("");d=n(f)}else if(e.toLowerCase()in _)d=n(_[e.toLowerCase()]);else{if("transparent"!==e.toLowerCase())return!1;d=[0,0,0,0]}return d}function o(e){return"rgba("+255*e[0]+", "+255*e[1]+", "+255*e[2]+", "+parseFloat(e[3])+")"}function i(){var e={fillStyle:[M.fillStyle[0],M.fillStyle[1],M.fillStyle[2],M.fillStyle[3]],strokeStyle:[M.strokeStyle[0],M.strokeStyle[1],M.strokeStyle[2],M.strokeStyle[3]],globalAlpha:M.globalAlpha,globalCompositeOperation:M.globalCompositeOperation,lineCap:M.lineCap,lineJoin:M.lineJoin,lineWidth:M.lineWidth,miterLimit:M.miterLimit,shadowColor:M.shadowColor,shadowBlur:M.shadowBlur,shadowOffsetX:M.shadowOffsetX,shadowOffsetY:M.shadowOffsetY,textAlign:M.textAlign,font:M.font,textBaseline:M.textBaseline,imageSmoothingEnabled:M.imageSmoothingEnabled};A.push(e)}function r(){A.length&&(M=A.pop())}function s(e){for(var t=h.transform.m_stack,a=0,n=h.transform.c_stack+1;n>a;++a)p.uniformMatrix3fv(e.uTransforms[a],!1,t[n-1-a])}function u(e,t){this.closed=!1,this.verts=[e,t,0,0]}function c(e){var t=h.transform,a=h.initShaders(t.c_stack+2,0),n=S[e],o=n.verts;p.bindBuffer(p.ARRAY_BUFFER,p.pathVertexPositionBuffer),p.bufferData(p.ARRAY_BUFFER,new Float32Array(o),p.STATIC_DRAW),p.vertexAttribPointer(a.vertexPositionAttribute,4,p.FLOAT,!1,0,0),t.pushMatrix(),s(a),p.uniform4f(a.uColor,M.fillStyle[0],M.fillStyle[1],M.fillStyle[2],M.fillStyle[3]),p.drawArrays(p.TRIANGLE_FAN,0,o.length/4),t.popMatrix()}function l(e){var t=h.transform,a=h.initShaders(t.c_stack+2,0),n=S[e],o=n.verts;p.bindBuffer(p.ARRAY_BUFFER,p.pathVertexPositionBuffer),p.bufferData(p.ARRAY_BUFFER,new Float32Array(o),p.STATIC_DRAW),p.vertexAttribPointer(a.vertexPositionAttribute,4,p.FLOAT,!1,0,0),t.pushMatrix(),s(a),p.uniform4f(a.uColor,M.strokeStyle[0],M.strokeStyle[1],M.strokeStyle[2],M.strokeStyle[3]),n.closed?p.drawArrays(p.LINE_LOOP,0,o.length/4):p.drawArrays(p.LINE_STRIP,0,o.length/4),t.popMatrix()}function f(t){if(this.obj=p.createTexture(),this.index=j.push(this),C.push(t),t.width>h.maxTextureSize||t.height>h.maxTextureSize){var a=document.createElement("canvas");a.width=t.width>h.maxTextureSize?h.maxTextureSize:t.width,a.height=t.height>h.maxTextureSize?h.maxTextureSize:t.height;var n=a.getContext("2d");n.drawImage(t,0,0,t.width,t.height,0,0,a.width,a.height),t=a}var o=p.LINEAR,i=p.LINEAR_MIPMAP_LINEAR;M.imageSmoothingEnabled||(o=p.NEAREST,i=p.LINEAR_MIPMAP_NEAREST),p.bindTexture(p.TEXTURE_2D,this.obj),p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,t),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,o),e(t.width)&&e(t.height)?(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,i),p.generateMipmap(p.TEXTURE_2D)):p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,o),p.bindTexture(p.TEXTURE_2D,null)}var h=this,p=this.gl,g=document.createElement("canvas");g.width=h.canvas.width,g.height=h.canvas.height;var m=g.getContext("2d"),v=/^rgb(a)?\(\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,\s*(-?[\d]+)(%)?\s*,?\s*(-?[\d\.]+)?\s*\)$/,b=/^hsl(a)?\(\s*(-?[\d\.]+)\s*,\s*(-?[\d\.]+)%\s*,\s*(-?[\d\.]+)%\s*,?\s*(-?[\d\.]+)?\s*\)$/,E=/^#([0-9A-Fa-f]{6})$/,w=/^#([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])$/,_={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},M={},A=[];M.fillStyle=[0,0,0,1],Object.defineProperty(p,"fillStyle",{get:function(){return o(M.fillStyle)},set:function(e){M.fillStyle=n(e)||M.fillStyle}}),M.strokeStyle=[0,0,0,1],Object.defineProperty(p,"strokeStyle",{get:function(){return o(M.strokeStyle)},set:function(e){M.strokeStyle=n(e)||drawStyle.strokeStyle}}),p.$lineWidth=p.lineWidth,M.lineWidth=1,Object.defineProperty(p,"lineWidth",{get:function(){return M.lineWidth},set:function(e){e>0&&(p.$lineWidth(e),M.lineWidth=e)}}),M.lineCap="butt",Object.defineProperty(p,"lineCap",{get:function(){return M.lineCap},set:function(e){M.lineCap=e}}),M.lineJoin="miter",Object.defineProperty(p,"lineJoin",{get:function(){return M.lineJoin},set:function(e){M.lineJoin=e}}),M.miterLimit=10,Object.defineProperty(p,"miterLimit",{get:function(){return M.miterLimit},set:function(e){M.miterLimit=e}}),M.shadowOffsetX=0,Object.defineProperty(p,"shadowOffsetX",{get:function(){return M.shadowOffsetX},set:function(e){M.shadowOffsetX=e}}),M.shadowOffsetY=0,Object.defineProperty(p,"shadowOffsetY",{get:function(){return M.shadowOffsetY},set:function(e){M.shadowOffsetY=e}}),M.shadowBlur=0,Object.defineProperty(p,"shadowBlur",{get:function(){return M.shadowBlur},set:function(e){M.shadowBlur=e}}),M.shadowColor="rgba(0, 0, 0, 0.0)",Object.defineProperty(p,"shadowColor",{get:function(){return M.shadowColor},set:function(e){M.shadowColor=e}}),M.font="10px sans-serif",Object.defineProperty(p,"font",{get:function(){return M.font},set:function(e){m.font=e,M.font=e}}),M.textAlign="start",Object.defineProperty(p,"textAlign",{get:function(){return M.textAlign},set:function(e){M.textAlign=e}}),M.textBaseline="alphabetic",Object.defineProperty(p,"textBaseline",{get:function(){return M.textBaseline},set:function(e){M.textBaseline=e}}),M.globalAlpha=1,Object.defineProperty(p,"globalAlpha",{get:function(){return M.globalAlpha},set:function(e){M.globalAlpha=e}}),M.imageSmoothingEnabled=!0,Object.defineProperty(p,"imageSmoothingEnabled",{get:function(){return M.imageSmoothingEnabled},set:function(e){M.imageSmoothingEnabled=!!e}}),M.globalCompositeOperation="source-over",Object.defineProperty(p,"globalCompositeOperation",{get:function(){return M.globalCompositeOperation},set:function(e){M.globalCompositeOperation=e}}),p.fillText=function(e,t,a){m.clearRect(0,0,h.canvas.width,h.canvas.height),m.fillStyle=p.fillStyle,m.fillText(e,t,a),p.drawImage(g,0,0)},p.strokeText=function(){},p.measureText=function(){return 1};var k=document.createElement("canvas"),P=k.getContext("2d");p.save=function(){h.transform.pushMatrix(),i()},p.restore=function(){h.transform.popMatrix(),r()},p.translate=function(e,t){h.transform.translate(e,t)},p.rotate=function(e){h.transform.rotate(e)},p.scale=function(e,t){h.transform.scale(e,t)},p.createImageData=function(e,t){return P.createImageData(e,t)},p.getImageData=function(e,t,a,n){var o=P.createImageData(a,n),i=new Uint8Array(a*n*4);p.readPixels(e,t,a,n,p.RGBA,p.UNSIGNED_BYTE,i);for(var r=4*a,s=n,u=0,d=s/2;d>u;++u)for(var c=0,l=r;l>c;++c){var f=u*r+c,h=(s-u-1)*r+c;o.data[f]=i[h],o.data[h]=i[f]}return o},p.putImageData=function(e,t,a){p.drawImage(e,t,a)},p.transform=function(e,t,a,n,o,i){h.transform.tr(e,t,a,n,o,i)},p.setTransform=function(e,t,a,n,o,i){h.transform.setIdentity(),p.transform.apply(this,arguments)},p.fillRect=function(e,t,a,n){var o=h.transform,i=h.initShaders(o.c_stack+2,0);p.bindBuffer(p.ARRAY_BUFFER,p.rectVertexPositionBuffer),p.vertexAttribPointer(i.vertexPositionAttribute,4,p.FLOAT,!1,0,0),o.pushMatrix(),o.translate(e,t),o.scale(a,n),s(i),p.uniform4f(i.uColor,M.fillStyle[0],M.fillStyle[1],M.fillStyle[2],M.fillStyle[3]),p.drawArrays(p.TRIANGLE_FAN,0,4),o.popMatrix()},p.strokeRect=function(e,t,a,n){var o=h.transform,i=h.initShaders(o.c_stack+2,0);p.bindBuffer(p.ARRAY_BUFFER,p.rectVertexPositionBuffer),p.vertexAttribPointer(i.vertexPositionAttribute,4,p.FLOAT,!1,0,0),o.pushMatrix(),o.translate(e,t),o.scale(a,n),s(i),p.uniform4f(i.uColor,M.strokeStyle[0],M.strokeStyle[1],M.strokeStyle[2],M.strokeStyle[3]),p.drawArrays(p.LINE_LOOP,0,4),o.popMatrix()},p.clearRect=function(e,t,a,n){};var S=[];p.beginPath=function(){S.length=0},p.closePath=function(){if(S.length){
var e=S[S.length-1],t=e.verts[0],a=e.verts[1];e.closed=!0;var n=new u(t,a);S.push(n)}},p.moveTo=function(e,t){S.push(new u(e,t))},p.lineTo=function(e,t){S.length?S[S.length-1].verts.push(e,t,0,0):p.moveTo(e,t)},p.quadraticApproximateCount=50,p.quadraticCurveTo=function(e,t,a,n){if(S.length)for(var o,i,r,s,u=S[S.length-1].verts,d=u[u.length-4],c=u[u.length-3],l=0;l<p.quadraticApproximateCount;l++)o=l/p.quadraticApproximateCount,i=1-o,r=i*i*d+2*i*o*e+o*o*a,s=i*i*c+2*i*o*t+o*o*n,u.push(r,s,0,0);else p.moveTo(a,n)},p.bezierApproximateCount=50,p.bezierCurveTo=function(e,t,a,n,o,i){if(S.length)for(var r,s,u,d,c=S[S.length-1].verts,l=c[c.length-4],f=c[c.length-3],h=0;h<p.bezierApproximateCount;h++)r=h/p.bezierApproximateCount,s=1-r,u=s*s*s*l+3*s*s*r*e+3*s*r*r*a+r*r*r*o,d=s*s*s*f+3*s*s*r*t+3*s*r*r*n+r*r*r*i,c.push(u,d,0,0);else p.moveTo(o,i)},p.arcTo=function(){S.length||p.moveTo(x,y)},p.rect=function(e,t,a,n){p.moveTo(e,t),p.lineTo(e+a,t),p.lineTo(e+a,t+n),p.lineTo(e,t+n),p.closePath()},p.arcApproximateCount=100,p.arc=function(e,t,a,n,o,i){if(S.length){var r=S[S.length-1].verts,s=e+a*Math.cos(n),u=t+a*Math.sin(n);for(r.push(s,u,0,0);n>2*Math.PI;)n-=2*Math.PI;for(;o>2*Math.PI;)o-=2*Math.PI;for(;n<2*-Math.PI;)n+=2*Math.PI;for(;o<2*-Math.PI;)o+=2*Math.PI;if(n==o)return;var d,c=1/p.arcApproximateCount,l=p.arcApproximateCount;i&&(o-=2*Math.PI,c=-c);for(var f=n;f>o&&i||o>f&&!i;f+=c)d!=(d=(f*l|0)/l)&&(s=e+a*Math.cos(d),u=t+a*Math.sin(d),r.push(s,u,0,0))}else p.moveTo(s,u)},p.fill=function(){for(var e=0;e<S.length;e++)c(e)},p.stroke=function(){for(var e=0;e<S.length;e++)l(e)},p.clip=function(){},p.isPointInPath=function(){},p.drawFocusRing=function(){};var C=[],j=[];p.drawImage=function(e,t,a,n,o,i,r,u,c){var l=h.transform;l.pushMatrix();var g=d.texture,m=!1;3===arguments.length?(l.translate(t,a),l.scale(e.width,e.height)):5===arguments.length?(l.translate(t,a),l.scale(n,o)):9===arguments.length&&(l.translate(i,r),l.scale(u,c),g|=d.crop,m=!0);var y,v=h.initShaders(l.c_stack+1,g),b=C.indexOf(e);y=-1!==b?j[b]:new f(e),m&&p.uniform4f(v.uCropSource,t/e.width,a/e.height,n/e.width,o/e.height),p.bindBuffer(p.ARRAY_BUFFER,p.rectVertexPositionBuffer),p.vertexAttribPointer(v.vertexPositionAttribute,4,p.FLOAT,!1,0,0),p.bindTexture(p.TEXTURE_2D,y.obj),p.activeTexture(p.TEXTURE0),p.uniform1i(v.uSampler,0),s(v),p.drawArrays(p.TRIANGLE_FAN,0,4),l.popMatrix()},Object.defineProperty(p,"isWebGL",{configurable:!1,enumerable:!0,writable:!1,value:!0})},u}),function(e,t){"function"==typeof define&&define.amd?define("io/InputManager",["jquery","utils/ArrayMap"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery"),require("utils/ArrayMap")):t(e.jQuery,e.ArrayMap)}("undefined"!=typeof window?window:global,function($,ArrayMap){"use strict";function getKey(e,t){return Object.keys(e).filter(function(a){return e[a]===t})[0]}var InputManager=function(e){this.j2d=e,this.id=e.id,this.element=e.element,this.data={mouse:{startPosition:{x:0,y:0},currentPosition:{x:0,y:0},previousDistance:0,distance:0},viewport:{position:{x:0,y:0}},enabled:!1,enableAdditionalData:!1,keysPressed:new ArrayMap,writeMode:!1,timePressed:0,preventAll:!1,cursor:{enabled:!1,image:"auto"}},this.keyMap={FULLSCREEN:[[InputManager.key.KEY_CTRL,InputManager.key.KEY_F11],"j2d.scene.toggleFullScreen",{}]}},checkKeyMap=function(e,enableCallback){void 0===enableCallback&&(enableCallback=!0);var j2d=e.data.manager.j2d,manager=e.data.manager,keyCode=e.which,keyMap=e.data.manager.keyMap;for(var index in keyMap)if(keyMap.hasOwnProperty(index)){var value=keyMap[index];if(!$.isArray(value[0])&&value[0]===keyCode&&value[1])return"string"==typeof value[1]&&(value[1]=eval("("+value[1]+")")),"function"==typeof value[1]&&enableCallback&&value[1](j2d,value[2]),!0;if($.isArray(value[0])&&manager.data.keysPressed.equals(value[0])&&value[1])return"string"==typeof value[1]&&(value[1]=eval("("+value[1]+")")),"function"==typeof value[1]&&enableCallback&&value[1](j2d,value[2]),!0}return!1},events={onMouseClick:function(e){var t=e.data.manager;if(!t.data.enabled||!t.j2d.isPlay||!t.j2d.element.hasClass("active"))return!0;var a=t.data.keysPressed,n=getKey(InputManager.key,e.which)||"KEY_UNKNOWN_"+e.which,o=t.data.mouse;2!==e.data.event?(0===e.data.event?(-1===$.inArray(InputManager.key[n],a)&&(a.push(InputManager.key[n]),t.data.enableAdditionalData&&(o.startPosition.x=e.pageX,o.startPosition.y=e.pageY,o.distance=0,t.data.timePressed=e.timeStamp)),(checkKeyMap(e,!1)||t.data.preventAll)&&e.preventDefault()):((checkKeyMap(e)||t.data.preventAll)&&e.preventDefault(),t.data.enableAdditionalData&&(o.previousDistance=o.distance,o.startPosition.x=0,o.startPosition.y=0),a.splice(a.indexOf(InputManager.key[n]),1)),t.element.trigger(0===e.data.event?"mouseKeyDown":"mouseKeyUp",{keyCode:n})):checkKeyMap(e,!1)&&e.preventDefault()},onMouseWheel:function(e){var t=e.data.manager;if(!t.data.enabled||!t.j2d.isPlay||!t.j2d.element.hasClass("active"))return!0;var a=t.data.keysPressed,n=e.originalEvent.wheelDelta/120>0?getKey(InputManager.key,4):getKey(InputManager.key,5);e.which=e.originalEvent.wheelDelta/120>0?4:5,-1===$.inArray(InputManager.key[n],a)&&a.push(InputManager.key[n]),(checkKeyMap(e)||t.data.preventAll)&&(e.preventDefault(),t.fixMouseWheel()),t.element.trigger("mouseWheel",{keyCode:n})},mouseWheelCancel:function(e,t){e.splice(e.indexOf(InputManager.key[t]),1)},onMouseMove:function(e){var t=e.data.manager,a=e.data.manager.data.mouse;t.data.mouse.currentPosition.x=e.pageX,t.data.mouse.currentPosition.y=e.pageY,e.data.manager.data.enableAdditionalData&&(a.distance=Math.sqrt(Math.pow(a.currentPosition.x-a.startPosition.x,2)+Math.pow(a.currentPosition.y-a.startPosition.y,2)).toFixed(1))},onKeyboardPress:function(e){var t=e.data.manager;if(!t.data.enabled||!t.j2d.isPlay||!t.element.hasClass("active"))return!0;var a=t.data.keysPressed,n=getKey(InputManager.key,e.which)||"KEY_UNKNOWN_"+e.which;if(2===e.data.event&&!0===t.data.writeMode){var o=String.fromCharCode(e.which||e.keyCode);e.preventDefault(),t.element.focus().trigger("keyboardCharPress",{key:e.which||e.keyCode,keyCode:n,"char":o})}2!==e.data.event&&!1===t.data.writeMode&&(0===e.data.event?(-1===$.inArray(InputManager.key[n],a)&&(a.push(InputManager.key[n]),t.data.enableAdditionalData&&(t.data.timePressed=e.timeStamp)),(checkKeyMap(e,!1)||t.data.preventAll)&&e.preventDefault()):((checkKeyMap(e)||t.data.preventAll)&&e.preventDefault(),a.splice(a.indexOf(InputManager.key[n]),1)),t.element.trigger(0===e.data.event?"keyboardKeyDown":"keyboardKeyUp",{keyCode:n,key:e.which||e.keyCode})),2!==e.data.event&&!0===t.data.writeMode&&t.element.trigger(0===e.data.event?"keyboardKeyDown":"keyboardKeyUp",{keyCode:n,key:e.which||e.keyCode})},onTouchTap:function(e){var t=e.data.manager;if(!t.data.enabled||!t.j2d.isPlay||!t.j2d.element.hasClass("active"))return!0;var a=t.data.keysPressed,n=getKey(InputManager.key,e.which+1)||"KEY_UNKNOWN_"+e.which,o=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],i=t.data.mouse;0===e.data.event?(-1===$.inArray(InputManager.key[n],a)&&(a.push(InputManager.key[n]),t.data.enableAdditionalData&&(i.startPosition.x=o.pageX,i.startPosition.y=o.pageY,i.distance=0,t.data.timePressed=e.timeStamp)),(checkKeyMap(e,!1)||t.data.preventAll)&&e.preventDefault()):((checkKeyMap(e)||t.data.preventAll)&&e.preventDefault(),t.data.enableAdditionalData&&(i.previousDistance=i.distance,i.startPosition.x=0,i.startPosition.y=0),a.splice(a.indexOf(InputManager.key[n]),1)),t.element.trigger(0===e.data.event?"mouseKeyDown":"mouseKeyUp",{keyCode:n})},onTouchMove:function(e){var t=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],a=e.data.manager.data.mouse;a.currentPosition.x=t.pageX.toFixed(0),a.currentPosition.y=t.pageY.toFixed(0),e.data.manager.data.enableAdditionalData&&(a.distance=Math.sqrt(Math.pow(a.currentPosition.x-a.startPosition.x,2)+Math.pow(a.currentPosition.y-a.startPosition.y,2)).toFixed(1))}},bindEvents=function(e){var t="[guid="+e.id+"]";$(document).on("contextmenu",t,{manager:e,event:2},events.onMouseClick),$(document).on("mousedown",t,{manager:e,event:0},events.onMouseClick),$(document).on("mouseup",t,{manager:e,event:1},events.onMouseClick),$(document).on("mousewheel",t,{manager:e},events.onMouseWheel),$(document).on("mousemove",t,{manager:e},events.onMouseMove),$(document).on("keydown",null,{manager:e,event:0},events.onKeyboardPress),$(document).on("keyup",null,{manager:e,event:1},events.onKeyboardPress),$(document).on("keypress",null,{manager:e,event:2},events.onKeyboardPress),$(document).on("touchstart",t,{manager:e,event:0},events.onTouchTap),$(document).on("touchend",t,{manager:e,event:1},events.onTouchTap),$(document).on("touchmove ",t,{manager:e},events.onTouchMove)},unbindEvents=function(e){var t="[guid="+e.id+"]";$(document).off("contextmenu",t,{manager:e,event:1},events.onMouseClick),$(document).off("mousedown",t,{manager:e,event:0},events.onMouseClick),$(document).off("mouseup",t,{manager:e,event:1},events.onMouseClick),$(document).off("mousewheel",t,{manager:e},events.onMouseWheel),$(document).off("mousemove",t,{manager:e},events.onMouseMove),$(document).off("keydown",null,{manager:e,event:0},events.onKeyboardPress),$(document).off("keyup",null,{manager:e,event:1},events.onKeyboardPress),$(document).off("keypress",null,{manager:e,event:2},events.onKeyboardPress),$(document).off("touchstart",t,{manager:e,event:0},events.onTouchTap),$(document).off("touchend",t,{manager:e,event:1},events.onTouchTap),$(document).off("touchmove ",t,{manager:e},events.onTouchMove)};InputManager.prototype.init=function(){!this.data.enabled&&global.j2dPlugin.pluginInit&&(bindEvents(this),this.data.enabled=!0)},InputManager.prototype.update=function(){if(!this.data.enabled)return!1;var e=this.j2d.scene.canvas.offsetWidth/this.j2d.scene.width,t=this.j2d.scene.canvas.offsetHeight/this.j2d.scene.height,a=this.data.mouse.currentPosition.x/e,n=this.data.mouse.currentPosition.y/t,o=this.element.offset();this.data.viewport.x=this.j2d.scene.viewport.x+a-o.left,this.data.viewport.y=this.j2d.scene.viewport.y+n-o.top},InputManager.prototype.flush=function(){this.data.keysPressed.length=0},InputManager.prototype.clear=function(){},InputManager.prototype.fixMouseWheel=function(){var e=this.data.keysPressed;-1!==$.inArray(InputManager.key.SCROLL_MOUSE_UP,e)?events.mouseWheelCancel(e,InputManager.key.SCROLL_MOUSE_UP):-1!==$.inArray(InputManager.key.SCROLL_MOUSE_DOWN,e)&&events.mouseWheelCancel(e,InputManager.key.SCROLL_MOUSE_DOWN)},InputManager.prototype.enable=function(){this.data.enabled||(this.data.enabled=!1)},InputManager.prototype.disable=function(){this.data.enabled&&(this.data.enabled=!1)},InputManager.prototype.load=function(e){var t=JSON.stringify(this.keyMap);return this.keyMap=JSON.parse(e),t},InputManager.prototype.save=function(){return JSON.stringify(this.keyMap)},InputManager.prototype.setKeys=function(e){this.keyMap=$.extend(!0,{},this.keyMap,e)};var getPressData=function(e,t){return e.data.enableAdditionalData?{keyList:t,time:Date.now()-e.data.timePressed}:!0};return InputManager.prototype.getMouseMoveDistance=function(){return this.data.enableAdditionalData?{current:this.data.mouse.distance,previous:this.data.mouse.previousDistance}:0},InputManager.prototype.checkPressedKeyList=function(e){return $.isArray(e)?e.length!==this.data.keysPressed.length?!1:this.data.keysPressed.equals(e)?(this.fixMouseWheel(),getPressData(this,e)):(this.fixMouseWheel(),!1):isNaN(e)?!1:-1!==this.data.keysPressed.indexOf(e)?(this.fixMouseWheel(),getPressData(this,e)):(this.fixMouseWheel(),!1)},InputManager.prototype.checkPressedKeyMap=function(e){if(void 0===this.keyMap[e])return!1;var t=this.keyMap[e][0];return this.checkPressedKeyList(t)},InputManager.prototype.getPosition=function(){return this.j2d.vector.v2f(this.data.viewport.x+.5,this.data.viewport.y+.5)},InputManager.prototype.setWriteMode=function(e){this.data.writeMode=e},InputManager.prototype.isWriteMode=function(){return!!this.data.writeMode},InputManager.prototype.setCursorImage=function(e){this.data.cursor.image='url("'+e+'"), auto',$(this.element).css("cursor",this.data.cursor.image)},InputManager.prototype.toggleCursor=function(e){void 0!==e?this.data.cursor.enable=e:this.data.cursor.enable=!this.data.cursor.enable,this.data.cursor.enable?$(this.element).css("cursor",this.data.cursor.image):(this.data.cursor.image=$(this.j2d.element).css("cursor"),$(this.element).css("cursor","none"))},InputManager.prototype.isCursorVisible=function(){return this.data.cursor.enable},InputManager.key={KEY_MOUSE_LEFT:1,KEY_MOUSE_MIDDLE:2,KEY_MOUSE_RIGHT:3,SCROLL_MOUSE_UP:4,SCROLL_MOUSE_DOWN:5,KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE_BAR:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW_KEY:91,KEY_RIGHT_WINDOW_KEY:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_LEFT_COMMAND:224,KEY_RIGHT_COMMAND:224},void 0!==global.J2D&&(global.InputManager=InputManager),InputManager}),function(e,t){"function"==typeof define&&define.amd?define("nodes/BaseNode",["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):t(e.jQuery)}("undefined"!=typeof window?window:global,function(e){"use strict";var t=function(){this.data={}};return void 0!==global.J2D&&(global.BaseNode=t),t}),function(e,t){"function"==typeof define&&define.amd?define("nodes/CameraNode",["nodes/BaseNode"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("nodes/BaseNode")):t(e.BaseNode)}("undefined"!=typeof window?window:global,function(e){"use strict";var t=function(){};return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.getCameraViewport=function(e,t){return null},void 0!==global.J2D&&(global.CameraNode=t),t}),function(e,t){"function"==typeof define&&define.amd?define("nodes/CollectionNode",["nodes/BaseNode"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("nodes/BaseNode")):t(e.BaseNode)}("undefined"!=typeof window?window:global,function(e){"use strict";var t=function(){};return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,void 0!==global.J2D&&(global.CollectionNode=t),t}),function(e,t){"function"==typeof define&&define.amd?define("utils/ArrayMap",[],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():t()}("undefined"!=typeof window?window:global,function(){"use strict";var e=function(e){Array.call(this,e)};return e.prototype=Object.create(Array.prototype),e.prototype.constructor=e,e.prototype.last=function(){return this[this.length-1]},e.prototype.equals=function(e){if(!e)return!1;if(this.length!=e.length)return!1;for(var t=0,a=this.length;a>t;t++)if(this[t]instanceof Array&&e[t]instanceof Array){if(!this[t].equals(e[t]))return!1}else if(this[t]!=e[t])return!1;return!0},Object.defineProperty(e.prototype,"equals",{enumerable:!1}),e.prototype.contains=function(e){for(var t=this.length;t--;)if(this[t]===e)return!0;return!1},Object.defineProperty(e.prototype,"contains",{enumerable:!1}),e.prototype.each=function(e){if(!e)return!1;for(var t=!1,a=0;a<this.length;a++)if(0==(t=e(this[a],a)))return t;return t},Object.defineProperty(e.prototype,"each",{enumerable:!1}),e.prototype.add=function(e,t){return this.contains(e)?this[e]=t:(this.push(e),this[e]=t),this},Object.defineProperty(e.prototype,"add",{enumerable:!1}),e.prototype.remove=function(e){for(var t=0;t<this.length;++t)if(this[t]==e)return this.splice(t,1),delete this[e],this;return this},Object.defineProperty(e.prototype,"remove",{enumerable:!1}),"function"==typeof define&&define.amd||(global.ArrayMap=e),e}),function(e,t){"function"==typeof define&&define.amd?define("utils/DeviceUtil",["jquery","utils/Vector2dInteger"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery"),require("utils/Vector2dInteger")):t(e.jQuery,e.Vector2dInteger)}("undefined"!=typeof window?window:global,function(e,t){"use strict";var a=function(){this.width=parseInt(e(document).width())<parseInt(screen.width)?parseInt(e(document).width()):parseInt(screen.width),this.height=parseInt(e(document).height())<parseInt(screen.height)?parseInt(e(document).height()):parseInt(screen.height)};return a.prototype.onResize=function(){return this.width=window.innerWidth,this.height=window.innerHeight,this},a.prototype.getWidth=function(){return this.width},a.prototype.getHeight=function(){return this.height},a.prototype.getSize=function(){return new t(this.width,this.height)},void 0===global.J2D&&(global.DeviceUtil=a),a}),function(e,t){"function"==typeof define&&define.amd?define("utils/Exceptions",[],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():t()}("undefined"!=typeof window?window:global,function(){"use strict";var e=function(e){Error.call(this),this.message=e,this.toString=function(){return this.message}};e.prototype=Object.create(Error.prototype),e.prototype.constructor=e;var t=function(t){e.call(this,t)};t.prototype=Object.create(e.prototype),t.prototype.constructor=t;var a=function(t){e.call(this,t)};a.prototype=Object.create(e.prototype),a.prototype.constructor=a;var n=function(t){e.call(this,t)};n.prototype=Object.create(e.prototype),n.prototype.constructor=n;var o=function(t){e.call(this,t)};o.prototype=Object.create(e.prototype),o.prototype.constructor=o;var i=function(t){e.call(this,t)};i.prototype=Object.create(e.prototype),i.prototype.constructor=i;var r=function(t){e.call(this,t)};r.prototype=Object.create(e.prototype),r.prototype.constructor=r;var s=function(t){e.call(this,t)};s.prototype=Object.create(e.prototype),s.prototype.constructor=s;var u=function(t){e.call(this,t)};u.prototype=Object.create(e.prototype),u.prototype.constructor=u;var d=function(t){e.call(this,t)};d.prototype=Object.create(e.prototype),d.prototype.constructor=d;var c=function(t){e.call(this,t)};c.prototype=Object.create(e.prototype),c.prototype.constructor=c,"function"==typeof define&&define.amd||(global.Exception=e,global.RuntimeException=t,global.InvalidArgumentException=a,global.BadFunctionCallException=n,global.BadMethodCallException=o,global.LengthException=i,global.LogicException=r,global.OutOfBoundsException=s,global.OutOfRangeException=u,global.RangeException=d,global.UnexpectedValueException=c)}),function(e,t){"function"==typeof define&&define.amd?define("utils/MathUtil",[],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():t()}("undefined"!=typeof window?window:global,function(){"use strict";var e=function(){};return e.number2Integer=function(e){return e>>0},e.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&e>-9007199254740992&&9007199254740992>e&&Math.floor(e)===e},e.randomColor=function(t,a,n){return"rgba("+e.random(t,a)+", "+e.random(t,a)+", "+e.random(t,a)+", "+n+")"},e.random=function(t,a,n){var o=Math.floor(Math.random()*(a-t+1)+t);return n&&0==o?e.random(t,a,n):o},e.degree2Radian=function(e){return e*(Math.PI/180)},e.radian2Degree=function(e){return e*(180/Math.PI)},void 0===global.J2D&&(global.MathUtil=e),e}),function(e,t){"function"==typeof define&&define.amd?define("utils/Vector2d",[],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t():t()}("undefined"!=typeof window?window:global,function(){"use strict";var e=function(e,t){this.x=e,this.y=t};return e.prototype.getX=function(){return this.x},e.prototype.getY=function(){return this.y},e.prototype.getVector=function(){return this},e.prototype.toArray=function(){return[this.x,this.y]},e.prototype.fromArray=function(e){return this.x=e[0],this.y=e[1],this},e.prototype.toString=function(){return"("+this.x+","+this.y+")"},void 0===global.J2D&&(global.Vector2d=e),e}),function(e,t){"function"==typeof define&&define.amd?define("utils/Vector2dInteger",["utils/Vector2d"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("utils/Vector2d")):t(e.Vector2d)}("undefined"!=typeof window?window:global,function(e){"use strict";var t=function(t,a){e.call(this,t>>0,a>>0)};return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.fromArray=function(e){return this.x=e[0]>>0,this.y=e[1]>>0,this},void 0===global.J2D&&(global.Vector2dInteger=t),t});
//# sourceMappingURL=jquery.j2d.min.map
