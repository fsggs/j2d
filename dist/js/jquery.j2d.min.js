!function(t,e){"function"==typeof define&&define.amd?define("jquery.j2d",["jquery"],e):e(t.jQuery)}(global,function(t){var e,i=t,n={vector:{},math:{},dom:{},now:0,dt:0,io:void 0,pause:!1,frameLimit:60,sceneStartTime:0,sceneSkipTime:0,engine:!1,ready:!1,window:window,webGL:!1};return e=function(t,e){var i=this;i.element=t,i.options=e,i.init(),i.gameEngine=function(){i.options.now=Date.now(),setTimeout(function(){i.options.pause||(i.options.io&&i.options.io.update(),i.options.dt=(i.options.now-i.options.lastTime)/100,i.options.dt>i.options.sceneSkipTime&&(i.options.dt=0),i.options.sceneStartTime=i.options.now,setTimeout(i.options.engine,0),i.options.lastTime=i.options.now,i.options.io&&i.options.io.clear()),n(i.gameEngine)},i.options.frameLimit<60?i.options.sceneSkipTime:0)};var n=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/i.options.frameLimit)}}()},e.prototype.getInfo=function(){return{name:"jquery.j2d",version:"0.1.5",site:"https://github.com/fsggs/jquery.j2d",info:"jquery.j2d - jQuery plugin of the fork j2ds.",author:"DeVinterX, Skaner(j2ds)"}},e.prototype.getIO=function(){return this.options.io},e.prototype.init=function(){this.layers&&(this.layers.parent=this),this.scene&&(this.scene.parent=this),delete this.init},e.prototype.IOHandler=function(t){return this.options.io=t},e.prototype.setWindow=function(t){this.window=t?t:window},e.prototype.start=function(t,e){var i=this;i.options.engine=t||function(){i.element.html("Пожалуйста, инициализируйте игровую функцию!")},i.options.frameLimit=e||60,i.options.sceneSkipTime=1e3/i.options.frameLimit,i.options.lastTime=Date.now(),i.options.dt=0,i.options.sceneStartTime=i.options.lastTime,i.gameEngine()},e.prototype.pause=function(){this.options.pause=!0,this.element.addClass("pause")},e.prototype.resume=function(){this.options.pause=!1,this.element.removeClass("pause").focus()},e.prototype.isPlay=function(){return!this.options.pause},e.prototype.enableWebGL=function(){this.options.webGL=!0},e.prototype.setActiveEngine=function(t){this.options.engine=t},e.prototype.getDevice=function(){return this.device},e.prototype.device={width:parseInt(i(document).width())<parseInt(screen.width)?parseInt(i(document).width()):parseInt(screen.width),height:parseInt(i(document).height())<parseInt(screen.height)?parseInt(i(document).height()):parseInt(screen.height),resize:function(){this.width=window.innerWidth,this.height=window.innerHeight}},e.prototype.vector={vec2df:function(t,e){return{x:t,y:e}},vec2di:function(t,e){return{x:t>>0,y:e>>0}}},e.prototype.math={toInt:function(t){return t>>0},randomColor:function(t,e,i){return"rgba("+this.random(t,e)+", "+this.random(t,e)+", "+this.random(t,e)+", "+i+")"},random:function(t,e,i){var n=Math.floor(Math.random()*(e-t+1)+t);return i&&0==n?this.random(t,e,i):n},rad:function(t){return t*(Math.PI/180)}},e.prototype.getLayers=function(){return this.layers},e.prototype.layers={parent:void 0,list:{}},e.prototype.layers.getLayer=function(t){return this.list[t]},e.prototype.layers.add=function(t,e){if(this.list[t])return!1;var i={},n=this.parent;return i.layerName=t,i.canvas=document.createElement("canvas"),i.canvas.width=n.scene.width,i.canvas.height=n.scene.height,i.width=n.scene.width,i.height=n.scene.height,i.context=i.canvas.getContext("2d"),i.context.shadowColor="rgba(0,0,0,0)",i.canvas.style.zIndex=1e3+e,i.canvas.style.position="fixed",i.canvas.style.left="0",i.canvas.style.top="0",i.canvas.id=t,i.opacity=1,i.angle=0,i.visible=1,i.onContext=function(t){t(this.context)},i.fill=function(t){this.context.fillStyle=t,this.context.fillRect(0,0,this.width,this.height)},i.setOpacity=function(t){this.canvas.style.opacity=t,this.opacity=t},i.getOpacity=function(){return this.opacity},i.setVisible=function(t){t?(this.canvas.style.display="block",this.visible=!0):(this.canvas.style.display="none",this.visible=!1)},i.isVisible=function(){return this.visible},i.setIndex=function(t){this.canvas.style.zIndex=1e3+t},i.clear=function(){this.context.clearRect(0,0,this.width,this.height)},i.clearNode=function(t){t.isLookScene()&&this.context.clearRect(t.pos.x-n.scene.viewport.x,t.pos.y-n.scene.viewport.y,t.size.x,t.size.y)},i.clearRect=function(t,e){this.context.clearRect(t.x-n.scene.viewport.x,t.y-n.scene.viewport.y,e.x,e.y)},this.list[t]=i,n.options.ready&&n.element.append(this.list[t].canvas),i},e.prototype.getScene=function(){return this.scene},e.prototype.scene={parent:void 0,enableFullscreen:!1,layerName:"sceneNode",layers:parent.layers?parent.layers:{}},e.prototype.scene.async=function(t,e){setTimeout(t.call(t,e),0)},e.prototype.scene.setGameState=function(t){this.parent.setActiveEngine(t),this.parent.element.trigger("changedGameState")},e.prototype.scene.start=function(t,e){this.parent.options.io&&this.parent.options.io.init(),this.parent.element.trigger("beforeStart"),this.parent.start(t,e),this.parent.element.trigger("afterStart")},e.prototype.scene.resizeToFullScreen=function(t){var e,i=this.parent,n=this,s=document.createElement("canvas"),o=s.getContext("2d");if(t){n.originalWidth=n.width,n.originalHeight=n.height,n.width=i.device.width,n.height=i.device.height;for(var r in i.layers.list)e=i.layers.list[r],s.width=e.width,s.height=e.height,o.drawImage(e.canvas,0,0),e.canvas.width=n.width,e.canvas.height=n.height,e.width=n.width,e.height=n.height,e.context.drawImage(s,0,0,e.width,e.height);n.enableFullscreen=!0}else{n.width=n.originalWidth,n.height=n.originalHeight;for(var r in i.layers.list)e=i.layers.list[r],e.width=n.originalWidth,e.height=n.originalHeight,e.canvas.width=n.originalWidth,e.canvas.height=n.originalHeight;n.enableFullscreen=!1}},e.prototype.scene.scaleToFullScreen=function(t){var e,i;if(t){for(i in this.parent.layers.list)this.parent.layers.list.hasOwnProperty(i)&&(e=this.parent.layers.list[i].canvas,e.style.width=this.parent.device.width+"px",e.style.height=this.parent.device.height+"px");this.enableFullscreen=!0,this.parent.element.width(this.parent.device.width).height(this.parent.device.height)}else{for(i in this.parent.layers.list)this.parent.layers.list.hasOwnProperty(i)&&(e=this.parent.layers.list[i].canvas,e.style.width=this.width+"px",e.style.height=this.height+"px");this.enableFullscreen=!1,this.parent.element.width(this.width).height(this.height)}},e.prototype.scene.toggleFullScreen=function(t,e){void 0===e&&(e={fullscreen:void 0}),!t.scene.enableFullscreen||e.fullscreen?t.scene.resizeToFullScreen(!0):t.scene.resizeToFullScreen(!1)},e.prototype.scene.setViewPosition=function(t){this.parent.scene.viewport.x=t.x-Math.ceil(this.parent.scene.width/2),this.parent.scene.viewport.y=t.y-Math.ceil(this.parent.scene.height/2)},e.prototype.scene.setViewFocus=function(t,e){this.parent.scene.viewport.x=t.getPosition().x-Math.ceil(this.parent.scene.width/2)+(e?e.x:0),this.parent.scene.viewport.y=t.getPosition().y-Math.ceil(this.parent.scene.height/2)+(e?e.y:0)},e.prototype.scene.viewMove=function(t){this.parent.scene.viewport.x+=t.x,this.parent.scene.viewport.y+=t.y},e.prototype.scene.clear=function(){this.getLayer().clear()},e.prototype.scene.getLayer=function(){return this.parent.layers.getLayer("sceneNode")},e.prototype.scene.init=function(t,e){var n=this.parent;n.element.trigger("beforeInit"),this.width=this.originalWidth=t,this.height=this.originalHeight=e,this.parent.element.width(t).height(e),n.layers.add("sceneNode",0),this.context=n.layers.getLayer("sceneNode").context,this.canvas=n.layers.getLayer("sceneNode").canvas,this.visible=!0,this.cancelClear=!1,this.viewport=n.vector.vec2df(0,0),n.element.trigger("afterInit"),i(window).ready(function(){for(var t in n.layers.list)n.layers.list.hasOwnProperty(t)&&n.element.append(n.layers.getLayer(t).canvas);n.options.ready=!0,n.element.trigger("ready")})},e.initJQueryPlugin=function(){i.fn.j2d=function(t){return t=i.extend(!0,{},n,t),this.filter("div.canvas:not([guid])").each(function(){i(this).data("j2d",new e(i(this),t)).addClass("j2d");var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"==t?e:3&e|8;return i.toString(16)});i(this).attr("guid",n);var s=i(this).attr("id");("undefined"==typeof s||s===!1)&&i(this).attr("id",n);var o=i(this).attr("tabindex");("undefined"==typeof o||o===!1)&&i(this).attr("tabindex","-1"),i(this).focus()}),1===i(this).length?i(this).data("j2d"):void 0},i(document).on("click","div.canvas[guid].pause",function(){i(this).data("j2d").resume()}),i(window).on("focus",function(){i("div.canvas[guid]").each(function(){i(this).data("j2d").resume()})}).on("blur",function(){i("div.canvas[guid]").each(function(){i(this).data("j2d").pause()})}),i(window).on("resize",function(){i("div.canvas[guid]").each(function(){i(this).data("j2d").device.resize()})})},e});