!function(e,t){"function"==typeof define&&define.amd?define("jquery.j2d",["jquery","j2d.webGL2d"],t):t(e.jQuery,e.WebGL2D)}(global,function(e,t){var i,n=e,s={vector:{},math:{},dom:{},now:0,dt:0,io:void 0,pause:!1,frameLimit:60,sceneStartTime:0,sceneSkipTime:0,engine:!1,ready:!1,window:window,webGL:!1};return i=function(e,t){var i=this;i.element=e,i.options=t,i.init(),i.gameEngine=function(){i.options.now=Date.now(),setTimeout(function(){i.options.pause||(i.options.io&&i.options.io.update(),i.options.dt=(i.options.now-i.options.lastTime)/100,i.options.dt>i.options.sceneSkipTime&&(i.options.dt=0),i.options.sceneStartTime=i.options.now,setTimeout(i.options.engine,0),i.options.lastTime=i.options.now,i.options.io&&i.options.io.clear()),n(i.gameEngine)},i.options.frameLimit<60?i.options.sceneSkipTime:0)};var n=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/i.options.frameLimit)}}()},i.prototype.getInfo=function(){return{name:"jquery.j2d",version:"0.1.5",site:"https://github.com/fsggs/jquery.j2d",info:"jquery.j2d - jQuery plugin of the fork j2ds.",author:"DeVinterX, Skaner(j2ds)"}},i.prototype.getIO=function(){return this.options.io},i.prototype.init=function(){this.layers&&(this.layers.parent=this),this.scene&&(this.scene.parent=this),delete this.init},i.prototype.IOHandler=function(e){return this.options.io=e},i.prototype.setWindow=function(e){this.window=e?e:window},i.prototype.start=function(e,t){var i=this;i.options.engine=e||function(){i.element.html("Пожалуйста, инициализируйте игровую функцию!")},i.options.frameLimit=t||60,i.options.sceneSkipTime=1e3/i.options.frameLimit,i.options.lastTime=Date.now(),i.options.dt=0,i.options.sceneStartTime=i.options.lastTime,i.gameEngine()},i.prototype.pause=function(){this.options.pause=!0,this.element.addClass("pause")},i.prototype.resume=function(){this.options.pause=!1,this.element.removeClass("pause").focus()},i.prototype.isPlay=function(){return!this.options.pause},i.prototype.enableWebGL=function(){this.options.webGL=!0},i.prototype.setActiveEngine=function(e){this.options.engine=e},i.prototype.getDevice=function(){return this.device},i.prototype.device={width:parseInt(n(document).width())<parseInt(screen.width)?parseInt(n(document).width()):parseInt(screen.width),height:parseInt(n(document).height())<parseInt(screen.height)?parseInt(n(document).height()):parseInt(screen.height),resize:function(){this.width=window.innerWidth,this.height=window.innerHeight}},i.prototype.vector={vec2df:function(e,t){return{x:e,y:t}},vec2di:function(e,t){return{x:e>>0,y:t>>0}}},i.prototype.math={toInt:function(e){return e>>0},randomColor:function(e,t,i){return"rgba("+this.random(e,t)+", "+this.random(e,t)+", "+this.random(e,t)+", "+i+")"},random:function(e,t,i){var n=Math.floor(Math.random()*(t-e+1)+e);return i&&0==n?this.random(e,t,i):n},rad:function(e){return e*(Math.PI/180)}},i.prototype.getLayers=function(){return this.layers},i.prototype.layers={parent:void 0,list:{}},i.prototype.layers.getLayer=function(e){return this.list[e]},i.prototype.layers.add=function(e,i){if(this.list[e])return!1;var n={},s=this.parent;return n.layerName=e,n.canvas=document.createElement("canvas"),n.canvas.width=s.scene.width,n.canvas.height=s.scene.height,n.width=s.scene.width,n.height=s.scene.height,s.options.webGL?(t.enable(n.canvas),n.context=n.canvas.getContext("WebGL-2d")):n.context=n.canvas.getContext("2d"),n.context.shadowColor="rgba(0,0,0,0)",n.canvas.style.zIndex=1e3+i,n.canvas.style.position="absolute",n.canvas.style.left="0",n.canvas.style.top="0",n.canvas.id=e,n.opacity=1,n.angle=0,n.visible=1,n.fillColor=!1,n.onContext=function(e){e(this.context)},n.fill=function(e){this.fillColor=e,this.context.fillStyle=e,this.context.fillRect(0,0,this.width,this.height)},n.setOpacity=function(e){this.canvas.style.opacity=e,this.opacity=e},n.getOpacity=function(){return this.opacity},n.setVisible=function(e){e?(this.canvas.style.display="block",this.visible=!0):(this.canvas.style.display="none",this.visible=!1)},n.isVisible=function(){return this.visible},n.setIndex=function(e){this.canvas.style.zIndex=1e3+e},n.clear=function(){this.context.clearRect(0,0,this.width,this.height)},n.clearNode=function(e){e.isLookScene()&&this.context.clearRect(e.pos.x-s.scene.viewport.x,e.pos.y-s.scene.viewport.y,e.size.x,e.size.y)},n.clearRect=function(e,t){this.context.clearRect(e.x-s.scene.viewport.x,e.y-s.scene.viewport.y,t.x,t.y)},n.resize=function(e,t){this.canvas.width=e,this.canvas.height=t,this.width=e,this.height=t,this.fillColor&&(this.context.save(),this.context.fillStyle=this.fillColor,this.context.fillRect(0,0,this.width,this.height),this.context.restore())},this.list[e]=n,s.options.ready&&s.element.append(this.list[e].canvas),n},i.prototype.getScene=function(){return this.scene},i.prototype.scene={parent:void 0,enableFullscreen:!1,layerName:"sceneNode",layers:parent.layers?parent.layers:{}},i.prototype.scene.resize=function(e,t){var i=this.parent;this.width=e,this.height=t;for(var n in i.layers.list)i.layers.list.hasOwnProperty(n)&&i.layers.list[n].resize(e,t)},i.prototype.scene.async=function(e,t){setTimeout(e.call(e,t),0)},i.prototype.scene.setGameState=function(e){this.parent.setActiveEngine(e),this.parent.element.trigger("changedGameState")},i.prototype.scene.start=function(e,t){this.parent.options.io&&this.parent.options.io.init(),this.parent.element.trigger("beforeStart"),this.parent.start(e,t),this.parent.element.trigger("afterStart")},i.prototype.scene.fullScreen=function(e){var t=document.getElementById(this.parent.element.attr("id"));void 0===t.requestFullscreen&&(t.requestFullscreen=t.webkitRequestFullscreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullscreen),void 0===document.exitFullscreen&&(document.exitFullscreen=document.webkitExitFullscreen||document.webkitCancelFullScreen||document.mozCancelFullScreen||document.msExitFullscreen),e?t.requestFullscreen():document.exitFullscreen()},i.prototype.scene.resizeToFullPage=function(e){var t=this.parent,i=this;e?(i.originalWidth=i.width,i.originalHeight=i.height,i.resize(t.device.width,t.device.height),i.enableFullscreen=!0):(i.resize(i.originalWidth,i.originalHeight),i.enableFullscreen=!1)},i.prototype.scene.scaleToFullScreen=function(e){var t,i;if(e){for(i in this.parent.layers.list)this.parent.layers.list.hasOwnProperty(i)&&(t=this.parent.layers.list[i].canvas,t.style.width=this.parent.device.width+"px",t.style.height=this.parent.device.height+"px");this.enableFullscreen=!0,this.parent.element.width(this.parent.device.width).height(this.parent.device.height)}else{for(i in this.parent.layers.list)this.parent.layers.list.hasOwnProperty(i)&&(t=this.parent.layers.list[i].canvas,t.style.width=this.width+"px",t.style.height=this.height+"px");this.enableFullscreen=!1,this.parent.element.width(this.width).height(this.height)}},i.prototype.scene.toggleFullScreen=function(e,t){void 0===t&&(t={fullscreen:void 0}),!e.scene.enableFullscreen||t.fullscreen?e.scene.fullScreen(!0):e.scene.fullScreen(!1)},i.prototype.scene.setViewPosition=function(e){this.parent.scene.viewport.x=e.x-Math.ceil(this.parent.scene.width/2),this.parent.scene.viewport.y=e.y-Math.ceil(this.parent.scene.height/2)},i.prototype.scene.setViewFocus=function(e,t){this.parent.scene.viewport.x=e.getPosition().x-Math.ceil(this.parent.scene.width/2)+(t?t.x:0),this.parent.scene.viewport.y=e.getPosition().y-Math.ceil(this.parent.scene.height/2)+(t?t.y:0)},i.prototype.scene.viewMove=function(e){this.parent.scene.viewport.x+=e.x,this.parent.scene.viewport.y+=e.y},i.prototype.scene.clear=function(){this.getLayer().clear()},i.prototype.scene.getLayer=function(){return this.parent.layers.getLayer("sceneNode")},i.prototype.scene.init=function(e,t){var i=this.parent;i.element.trigger("beforeInit"),this.width=this.originalWidth=e,this.height=this.originalHeight=t,this.parent.element.width(e).height(t),i.layers.add("sceneNode",0),this.context=i.layers.getLayer("sceneNode").context,this.canvas=i.layers.getLayer("sceneNode").canvas,this.visible=!0,this.cancelClear=!1,this.viewport=i.vector.vec2df(0,0),i.element.trigger("afterInit"),n(window).ready(function(){for(var e in i.layers.list)i.layers.list.hasOwnProperty(e)&&i.element.append(i.layers.getLayer(e).canvas);i.options.ready=!0,i.element.trigger("ready")})},i.initJQueryPlugin=function(){n.fn.j2d=function(e){return e=n.extend(!0,{},s,e),this.filter("div.canvas:not([guid])").each(function(){n(this).data("j2d",new i(n(this),e)).addClass("j2d");var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,i="x"==e?t:3&t|8;return i.toString(16)});n(this).attr("guid",t);var s=n(this).attr("id");("undefined"==typeof s||s===!1)&&n(this).attr("id",t);var o=n(this).attr("tabindex");("undefined"==typeof o||o===!1)&&n(this).attr("tabindex","-1"),n(this).focus()}),1===n(this).length?n(this).data("j2d"):void 0};var e=!1;n(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange msfullscreenchange","div.canvas[guid]",function(t){e=!!(document.webkitFullscreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement||document.msFullscreenElement),e||n(this).data("j2d").scene.resizeToFullPage(e)}),n(document).on("click","div.canvas[guid].pause",function(){n(this).data("j2d").resume()}),n(window).on("focus",function(){n("div.canvas[guid]").each(function(){n(this).data("j2d").resume()})}).on("blur",function(){n("div.canvas[guid]").each(function(){n(this).data("j2d").pause()})}),n(window).on("resize",function(){n("div.canvas[guid]").each(function(){n(this).data("j2d").device.resize(),e&&n(this).data("j2d").scene.resizeToFullPage(e)})})},i});